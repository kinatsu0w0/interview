<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICF電訪問卷</title>
    <style>
        /* 定義 CSS 變數 */
        :root {
            --body-bg: #eef1f4;
            --container-bg: #f7f9fb;
            --container-shadow: rgba(0, 0, 0, 0.05);
            --header-bg: rgba(247, 249, 251, 0.95);
            --header-shadow: rgba(0, 0, 0, 0.05);
            --text-color-primary: #4a4a4a;
            --text-color-secondary: #5c5c5c;
            --border-color: #dcdfe3;
            --button-bg: #6c757d;
            --button-hover-bg: #5a6268;
            --dropdown-bg: #f7f9fb;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: var(--body-bg);
            padding-top: 100px;
            color: var(--text-color-secondary);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px var(--container-shadow);
        }

        h1, h2, h3 {
            color: var(--text-color-primary);
        }

        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 30px;
        }

        #sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--header-bg);
            box-shadow: 0 2px 5px var(--header-shadow);
            z-index: 1000;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #header-fields {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        #actions {
            display: flex;
            gap: 10px;
        }

        /* 巢狀下拉式選單樣式 */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none; /* 預設隱藏 */
            position: absolute;
            top: 100%; /* 在按鈕下方顯示 */
            right: 0;
            background-color: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            padding: 5px;
            z-index: 999;
            white-space: nowrap;
            flex-direction: column;
            gap: 5px;
        }
        
        .dropdown-content.active {
            display: flex; /* 點擊後顯示 */
        }

        .dropdown-content .dropdown-content {
            top: 0; /* 子選單與父選單對齊 */
            right: 100%; /* 子選單在父選單左側 */
            padding: 5px;
            margin-right: 5px;
        }

        .dropdown-content button {
            width: 100%;
            text-align: left;
        }
        
        .question-card {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .question-card h3 {
            flex-shrink: 0;
            width: 180px;
            margin: 0;
            padding-right: 10px;
            color: var(--text-color-primary);
            font-size: 1em;
            line-height: 1.5;
            display: flex;
        }

        .question-card h3 .title-prefix {
            flex: 0 0 auto;
        }

        .question-card h3 .title-text {
            flex: 1;
            flex-wrap: wrap;
        }

        .options-container {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            line-height: 1.5;
        }

        .option {
            display: inline-flex;
            align-items: flex-start;
            margin-right: 15px;
            margin-bottom: 5px;
            cursor: pointer;
            padding: 2px 0;
            color: var(--text-color-secondary);
        }

        .option input[type="radio"],
        .option input[type="checkbox"] {
            margin-right: 5px;
            position: relative;
            top: 2px;
        }

        .conditional-input {
            margin-left: 10px;
            padding: 3px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .full-width-input,
        .full-width-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .full-width-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .sub-content-container {
            width: 100%;
            padding-left: 20px;
            margin-top: 10px;
            border-left: 2px solid var(--border-color);
            transition: all 0.3s ease-in-out; 
        }

        .sub-content-container.hidden {
            display: none !important; 
        }

        .caregiver-template label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
            color: var(--text-color-secondary);
        }

        .caregiver-template input {
            width: auto;
            margin-left: 5px;
        }

        #actions button {
            padding: 10px 15px;
            border: none;
            background-color: var(--button-bg);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        #actions button:hover {
            background-color: var(--button-hover-bg);
        }

        .unanswered {
            outline: 2px solid red;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .murmur{
            font-size: 15px;
            font-weight: 100;
        }
    </style>
</head>
<body>
    <div id="sticky-header">
        <div id="header-fields">
            <label>問卷編號: <input type="text" id="survey-number" placeholder="請填寫"></label>
            <label>主機:
                <select id="machine-number">
                    <option value="一">一</option>
                    <option value="二">二</option>
                    <option value="三">三</option>
                    <option value="四">四</option>
                    <option value="五">五</option>
                    <option value="六">六</option>
                    <option value="未存檔">未存檔</option>
                </select>
            </label>
            <label>受訪者:
                <select id="respondent-type">
                    <option value="本人">本人</option>
                    <option value="主要照顧者">主要照顧者</option>
                    <option value="其他">其他</option>
                </select>
            </label>
            <label>分流三:
                <select id="flow-three">
                    <option value="否">否</option>
					<option value="機構">機構</option>
                    <option value="高負荷照顧">高負荷照顧</option>
					<option value="身2">身2</option>
					<option value="雙老">雙老</option>
					<option value="獨居且為視覺障礙者">獨居且為視覺障礙者</option>
					<option value="其他">其他</option>
                </select>
            </label>
        </div>
        <div id="actions">
            <div id="tools-area" class="dropdown">
                <button id="tools-toggle">小工具</button>
                <div id="tools-dropdown" class="dropdown-content">
                    <div id="theme-tools" class="dropdown">
                        <button>顏色</button>
                        <div id="theme-dropdown" class="dropdown-content">
                            <button id="theme-beige">米白</button>
                            <button id="theme-green">淡綠</button>
                            <button id="theme-gray">淺灰</button>
                        </div>
                    </div>
                    <button id="validate-btn">檢查未填寫項目</button>
                </div>
            </div>
            <button id="copy-btn">複製內容</button>
            <button id="download-btn">下載檔案</button>
            <button id="clear-btn">清除表單</button>
        </div>
    </div>

    <div class="container">
        <h2>電訪問卷<br><span class="murmur">2025.9.11跟長照所開完會後修改的版本</span></h2>
        <form id="survey-form"></form>
    </div>

    <script>
        // =========================
        // 1. 資料結構與變數
        // =========================
        const categories = [
            {
                title: "一、個案概況",
                questions: [
                    {
                        title: "認知能力",
                        type: "multiple-choice",
                        options: ["無困難", "可聽懂簡單指令", "答非所問", "時好時壞", "混亂", "短期記憶退化", "僅眨眼、無法判定", "大聲說話才可理解","可部分辨認出家人","完全認不出人", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "精神狀況",
                        type: "multiple-choice",
                        options: ["情緒穩定", "情緒不穩定", "幻聽、幻覺", "妄想", "脫序行為", "人際退縮", "憂鬱", "日夜顛倒", "嗜睡", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "表達功能",
                        type: "multiple-choice",
                        options: ["無困難", "可使用簡單字句", "一問一答", "只用單字／詞回復", "鮮少開口", "構音不清", "仿說", "說話緩慢", "無法言語", "使用肢體回應","用手寫回應", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "肢體障礙",
                        type: "multiple-choice",
                        options: ["無困難", "左上肢", "右上肢", "雙上肢", "左下肢", "右下肢", "雙下肢","脊椎", "全癱", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "行動能力",
                        type: "multiple-choice",
                        options: ["無困難（小於5%）", "很少有困難（5%-25%）", "偶爾有困難（25%-50%）", "經常有困難（50%-95%）", "無法行走（大於95%）","容易疲倦", "重心不穩、偏移", "小碎步", "拖步", "跛行", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "輔具使用",
                        type: "single-choice",
                        options: [
                            { 
                                text: "無",
                                subQuestions:[
                                    {
                                        title: "居家／熟悉環境的移動方式",
                                        type: "multiple-choice",
                                        options: ["不使用輔具"],
                                    },
                                    {
                                        title: "戶外移動方式",
                                        type: "multiple-choice",
                                        options: ["不使用輔具"],
                                    },
                                ]
                            },
                            {
                                text: "有", 
                                subQuestions:[
                                    {
                                        title: "目前有使用的輔具",
                                        type: "multiple-choice",
                                        name: "assistive-devices-list",
                                        options: ["單拐", "四腳拐", "雨傘拐", "助行器", "輪椅", "電動輪椅", "電動代步車", "助聽器", "便盆椅", "沐浴椅", "氣墊床墊", "病床","電動床", { text: "其他", hasInputField: true }],
                                    },
                                    {
                                        title: "居家／熟悉環境的移動方式",
                                        type: "multiple-choice",
                                        options: ["不使用輔具"],
                                    },
                                    {
                                        title: "戶外移動方式",
                                        type: "multiple-choice",
                                        options: ["不使用輔具"],
                                    },
                                ],
                            },
                        ],
                    },
                    {
                        title: "戶外移動樣態",
                        type: "input-only",
                    },
                    {
                        title: "近期碰撞／跌倒狀況",
                        type: "single-choice",
                        options: ["無", "有"],
                    },
                    {
                        title: "生活自理",
                        type: "single-choice",
                        options: [
                            "可自理",
                            {
                                text: "部分須協助",
                                subQuestions:[
                                    {
                                        title: "協助者",
                                        type: "multiple-choice",
                                        options: ["家人", "看護／外籍看護", "居服員", "機構照服員", { text: "其他", hasInputField: true }],
                                    },
                                    {
                                        title: "進食方式",
                                        type: "multiple-choice",
                                        options: ["自行使用餐具", "他人餵食", "管灌","營養輸液注射"],
                                    },
                                    {
                                        title: "如廁狀況",
                                        type: "single-choice",
                                        options: ["不須叮嚀", "須叮嚀","部份協助", "尿布", "尿管"],
                                    },
                                    {
                                        title: "沐浴方式",
                                        type: "single-choice",
                                        options: ["不須叮嚀", "須叮嚀","部份協助",  "他人協助"],
                                    },
                                    {
                                        title: "穿脫衣服",
                                        type: "single-choice",
                                        options: ["自理", "他人協助", "完全依賴他人"],
                                    },
                                ],
                            },
                            {
                                text: "完全仰賴他人",
                                subQuestions:[
                                    {
                                        title: "協助者",
                                        type: "multiple-choice",
                                        options: ["家人", "看護／外籍看護", "居服員", "機構照服員", { text: "其他", hasInputField: true }],
                                    },
                                    {
                                        title: "進食方式",
                                        type: "multiple-choice",
                                        options: ["自行使用餐具", "他人餵食", "管灌","營養輸液注射"],
                                    },
                                    {
                                        title: "如廁狀況",
                                        type: "single-choice",
                                        options: ["不須叮嚀", "須叮嚀","部份協助", "尿布", "尿管"],
                                    },
                                    {
                                        title: "沐浴方式",
                                        type: "single-choice",
                                        options: ["不須叮嚀", "須叮嚀","部份協助",  "他人協助"],
                                    },
                                    {
                                        title: "穿脫衣服",
                                        type: "single-choice",
                                        options: ["自理", "他人協助", "完全依賴他人"],
                                    },
                                ],
                            },
                        ],
                    },
                    {
                        title: "就醫情形",
                        type: "single-choice",
                        options: ["定期就醫", "生病卻長期未就醫", "有需求時再去", { text: "其他／補充說明", hasInputField: true }],
                    },
                    {
                        title: "就業狀況",
                        type: "single-choice",
                        options: ["無", { text: "就業中", hasInputField: true }, { text: "就學中", hasInputField: true }, "退休", { text: "其他", hasInputField: true }],
                    },
                    {
                        title: "交通能力",
                        type: "single-choice",
                        options: [
                            "無",
                            { 
                                text: "有",
                                subQuestions: [
                                    {
                                        title: "交通方式",
                                        type: "multiple-choice",
                                        options: ["搭乘大眾運輸工具", "自行開車／騎機車／腳踏車／電動代步車", "復康巴士", "長照交通車", "計程車", "機構車", "家人接送", "需陪伴", "不須陪伴", { text: "其他", hasInputField: true }],
                                    },
                                ]
                            }
                        ],
                    },
                    {
                        title: "居住狀況",
                        type: "single-choice",
                        options: ["獨居", "與家人親友（或外看）同住", { text: "入住機構", hasInputField: true }, { text: "其他", hasInputField: true }],
                    },
                    {
                        title: "使用長照服務",
                        type: "single-choice",
                        options: [
                            "無",
                            {
                                text: "有", 
                                subQuestions: [ 
                                    {
                                        title: "服務項目", 
                                        type: "multiple-choice",
                                        options: [
                                            {
                                                text: "居家服務",
                                                subQuestions: [ 
                                                    {
                                                        title: "居家服務細項",
                                                        type: "multiple-choice",
                                                        options: ["沐浴", "備餐", "陪伴外出", { text: "其他", hasInputField: true }]
                                                    }
                                                ]
                                            },
                                            { text: "日照中心", hasInputField: true },
                                            "機構喘息",
                                            "交通車",
                                            { text: "其他", hasInputField: true }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                ],
            },
            {
                title: "二、家庭概況",
                questions: [
                    {
                        title: "家庭成員及彼此關係",
                        type: "textarea-only",
                    },
                    {
                        title: "主要照顧者",
                        type: "single-choice",
                        options: [
                            "無", 
                            { 
                                text: "有", 
                                subQuestions: [
                                    {
                                        title: "照顧者姓名",
                                        type: "input-only"
                                    },
                                    {
                                        title: "照顧者年紀",
                                        type: "input-only"
                                    },
                                    {
                                        title: "與被照顧者的關係",
                                        type: "input-only"
                                    },
                                    {
                                        title: "照顧者是否為身心障礙者",
                                        type: "single-choice",
                                        options: [
                                            "否", 
                                            {
                                                text: "是",
                                                subQuestions: [ 
                                                    {
                                                        title: "身心障礙類別",
                                                        type: "input-only",
                                                    },
                                                    {
                                                        title: "身體健康狀況",
                                                        type: "input-only" 
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        title: "主要照顧者",
                        type: "single-choice",
                        options: [
                            "無", 
                            { 
                                text: "有", 
                                subQuestions: [
                                    {
                                        title: "照顧者姓名",
                                        type: "input-only"
                                    },
                                    {
                                        title: "照顧者年紀",
                                        type: "input-only"
                                    },
                                    {
                                        title: "與被照顧者的關係",
                                        type: "input-only"
                                    },
                                    {
                                        title: "照顧者是否為身心障礙者",
                                        type: "single-choice",
                                        options: [
                                            "否", 
                                            {
                                                text: "是",
                                                subQuestions: [ 
                                                    {
                                                        title: "身心障礙類別",
                                                        type: "input-only",
                                                    },
                                                    {
                                                        title: "身體健康狀況",
                                                        type: "input-only" 
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        title: "經濟來源",
                        type: "multiple-choice",
                        options: [
                            {
                                text: "有穩定來源",
                                subQuestions:[
                                    {
                                        title: "退休金",
                                        type: "multiple-choice",
                                        options: ["勞退",　"漁退", "公退", "農退", "榮民退"]
                                    },
                                    {
                                        title: "福利補助",
                                        type: "multiple-choice",
                                        options: ["身心障礙者生活補助", "身心障礙者日間照顧及住宿式照顧費用補助", "住宿式服務機構使用者補助方案","低收生活補助", "國民年金", "老人年金", "老農漁津貼"]
                                    },
                                ]
                            },
                            "依靠存款",
                            { text: "家人經濟援助", hasInputField: true },
                            { text: "其他", hasInputField: true },
                        ],
                    },
                ],
            },
            {
                title: "三、資源使用情況",
                questions: [
                    {
                        title: "已使用資源",
                        type: "multiple-choice",
                        options: ["身障證明請領補換", "迷失手鍊／Q布標", "長照服務", "牌照稅減免補助、健保費及掛號費減免", "脆家通報", "自殺通報", { text: "其他", hasInputField: true }],
                    },
                    {
                        title: "建議使用／資源提供說明",
                        type: "multiple-choice",
                        options: ["身障證明請領補換", "迷失手鍊／Q布標", "長照服務", "牌照稅減免補助、健保費及掛號費減免", "脆家通報", "自殺通報", { text: "其他", hasInputField: true }],
                    },
                    {
                        title: "協助申請／轉介",
                        type: "multiple-choice",
                        options: ["迷失手鍊／Q布標", "長照服務", "牌照稅減免補助、健保費及掛號費減免", "脆家通報", "自殺通報", { text: "其他", hasInputField: true }],
                    },
                ],
            },
            {
                title: "四、目前所遇困難或待協助需求事項",
                questions: [
                    {
                        title: "目前所遇困難或待協助需求事項",
                        type: "input-only",
                    },
                ],
            }
        ];

        const formContainer = document.getElementById("survey-form");
        const chineseNumbers = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十"];
        const mobilityOptions = ["獨立行走", "扶著家具／物品／牆壁行走", "需要安全看視", "他人攙扶", "他人推行"];
        const themes = {
            gray: {
                '--body-bg': '#eef1f4',
                '--container-bg': '#f7f9fb',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(247, 249, 251, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#4a4a4a',
                '--text-color-secondary': '#5c5c5c',
                '--border-color': '#dcdfe3',
                '--button-bg': '#6c757d',
                '--button-hover-bg': '#5a6268',
                '--dropdown-bg': '#f7f9fb',
            },
            beige: {
                '--body-bg': '#f8f5eb',
                '--container-bg': '#fffdf7',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(255, 253, 247, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#5d564f',
                '--text-color-secondary': '#4a453e',
                '--border-color': '#e0d9c4',
                '--button-bg': '#7f6e59',
                '--button-hover-bg': '#635647',
                '--dropdown-bg': '#fffdf7',
            },
            green: {
                '--body-bg': '#eaf1e7',
                '--container-bg': '#f8fcf7',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(248, 252, 247, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#4b6a5b',
                '--text-color-secondary': '#3f5e51',
                '--border-color': '#b3d9c7',
                '--button-bg': '#55998a',
                '--button-hover-bg': '#4a7d71',
                '--dropdown-bg': '#f8fcf7',
            }
        };

        // =========================
        // 新增的切換主題功能
        // =========================
        function switchTheme(themeName) {
            const root = document.documentElement;
            const selectedTheme = themes[themeName];
            for (const property in selectedTheme) {
                root.style.setProperty(property, selectedTheme[property]);
            }
        }

        // =========================
        // 2. 函式
        // =========================

        function createQuestionElement(question, questionIndex, container) {
            const questionCard = document.createElement("div");
            questionCard.className = "question-card";
            const qIdBase = `${question.title.replace(/[\s\/\(\)]/g, "")}`;
            questionCard.id = `q-${qIdBase}-${questionIndex}`;

            const isSubQuestion = typeof questionIndex === 'string';
            const titlePrefix = isSubQuestion ? '' : `（${chineseNumbers[questionIndex]}）`;

            const h3 = document.createElement("h3");
            h3.innerHTML = `<span class="title-prefix">${titlePrefix}</span><span class="title-text">${question.title}</span>`;
            questionCard.appendChild(h3);

            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options-container";
            questionCard.appendChild(optionsContainer);

            if (question.type === "input-only" || question.type === "textarea-only") {
                const input = document.createElement(question.type === "textarea-only" ? "textarea" : "input");
                input.className = question.type === "textarea-only" ? "full-width-textarea" : "full-width-input";
                optionsContainer.appendChild(input);
            } else {
                const inputType = question.type === "single-choice" ? "radio" : "checkbox";
                let subContentContainer;

                const hasPotentialSubContent = question.options.some(opt => typeof opt === 'object' && (opt.subQuestions || opt.hasConditionalTemplate));
                if (hasPotentialSubContent) {
                    subContentContainer = document.createElement("div");
                    subContentContainer.className = "sub-content-container hidden";
                    questionCard.appendChild(subContentContainer);
                }

                question.options.forEach((option, optionIndex) => {
                    const isObject = typeof option === 'object' && option !== null;
                    const optionText = isObject ? option.text : option;
                    const label = document.createElement("label");
                    label.className = "option";
                    const inputId = `${qIdBase}-${questionIndex}-${optionIndex}`;
                    const inputName = question.name || `${qIdBase}-${questionIndex}`;
                    label.innerHTML = `<input type="${inputType}" name="${inputName}" value="${optionText}" id="${inputId}">${optionText}`;
                    optionsContainer.appendChild(label);
                    const inputElement = label.querySelector("input");
                    if (isObject && option.hasInputField) {
                        const inputField = document.createElement("input");
                        inputField.type = "text";
                        inputField.placeholder = "請填寫";
                        inputField.className = "conditional-input";
                        inputField.style.display = "none";
                        label.appendChild(inputField);
                        inputElement.addEventListener("change", () => {
                            inputField.style.display = inputElement.checked ? "inline-block" : "none";
                            if (!inputElement.checked) inputField.value = "";
                        });
                    }
                });

                if (subContentContainer) {
                    const inputName = question.name || `${qIdBase}-${questionIndex}`;
                    const allInputsInGroup = optionsContainer.querySelectorAll(`input[name="${inputName}"]`);
                    const handleSubContentDisplay = () => {
                        const checkedInput = optionsContainer.querySelector(`input[name="${inputName}"]:checked`);
                        subContentContainer.innerHTML = '';
                        subContentContainer.classList.add("hidden");
                        if (!checkedInput) return;
                        const selectedOptionData = question.options.find(opt => (typeof opt === 'object' ? opt.text : opt) === checkedInput.value);

                        let subQuestionsToShow = [];
                        if (selectedOptionData && typeof selectedOptionData === 'object') {
                            if (selectedOptionData.subQuestions) {
                                subQuestionsToShow = selectedOptionData.subQuestions;
                            }
                        }
                        
                        if (subQuestionsToShow.length > 0) {
                            subQuestionsToShow.forEach((subQ, subQIndex) => {
                                createQuestionElement(subQ, `${questionIndex}-${subQIndex}`, subContentContainer);
                            });
                            subContentContainer.classList.remove("hidden");

                            if (question.title === '輔具使用') {
                                const assistiveDevicesCheckboxes = subContentContainer.querySelectorAll('input[name^="assistive-devices-list"]');
                                assistiveDevicesCheckboxes.forEach(checkbox => {
                                    checkbox.addEventListener('change', () => updateMobilityOptions(subContentContainer));
                                });
                                updateMobilityOptions(subContentContainer);
                            }
                        }
                    };
                    allInputsInGroup.forEach(input => {
                        input.addEventListener('change', handleSubContentDisplay);
                    });
                }
            }
            container.appendChild(questionCard);
        }

        function getQuestionData(questionCard, question) {
            if (!questionCard || !question) return "";

            if (question.type === 'multiple-choice' || question.type === 'single-choice') {
                const checkedInputs = Array.from(questionCard.querySelectorAll(':scope > .options-container > .option > input:checked'));
                if (checkedInputs.length > 0) {
                    return checkedInputs.map(getOptionText).join("、");
                }
                return "";
            }
            return "";
        }

        function getOptionText(inputElement) {
           const label = inputElement.closest('label');
           if (!label) return inputElement.value; 

           let text = inputElement.value;

           const conditionalInput = label.querySelector('.conditional-input');
           if (conditionalInput && conditionalInput.style.display !== 'none' && conditionalInput.value.trim()) {
               text += `（${conditionalInput.value.trim()}）`;
           }

           const selectElement = label.querySelector('select');
           if (selectElement && selectElement.value && selectElement.value !== "請選擇") {
               text += `（${selectElement.value}）`;
           }

           return text;
        }

        function parseAnswersFromContainer(optionsContainer) {
            if (!optionsContainer) return "";

            // 優先 1: 尋找「勾選題」（radio/checkbox）的答案
            const checkedInputs = Array.from(optionsContainer.querySelectorAll('.option > input:checked'));
            if (checkedInputs.length > 0) {
                // 如果找到了，這就是一個 single-choice 或 multiple-choice 題
                // 使用 getOptionText 來確保能抓到 select 的值
                return checkedInputs.map(getOptionText).join("、");
            }

            // 優先 2: 如果找不到勾選題，就尋找「輸入框」（input-only / textarea-only）
            // 這些題目的輸入框會被直接放在 optionsContainer 裡
            const simpleInput = optionsContainer.querySelector('input.full-width-input, textarea.full-width-textarea');
            if (simpleInput && simpleInput.value.trim()) {
                // 如果找到了，這就是一個 input-only 或 textarea-only 題
                return simpleInput.value.trim();
            }

            // 如果以上皆非（例如一個空的勾選題），則回傳空字串
            return "";
        }

        function getMobilityData(questionCard) {
            const selectedOptions = [];
            const optionsContainer = questionCard.querySelector(".options-container");
            const labels = optionsContainer.querySelectorAll("label");

            labels.forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                const select = label.querySelector('select');

                if (checkbox && checkbox.checked) {
                    let optionText = checkbox.value;
                    if (select && select.value !== "請選擇") {
                        optionText += `（${select.value}）`;
                    }
                    selectedOptions.push(optionText);
                }
            });

            return selectedOptions;
        }

        function clearForm() {
            const formInputs = formContainer.querySelectorAll('input, textarea, select');
            
            formInputs.forEach(input => {
                const type = input.type;
                
                if (type === 'radio' || type === 'checkbox') {
                    if (input.checked) { // 只對已勾選的進行操作，效率更高
                        input.checked = false;
                        
                        // ⭐ 魔法就在這裡 ⭐
                        // 手動觸發 change 事件，通知我們的動態系統進行更新！
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    if (input.value !== '') { // 只對有內容的進行操作
                        input.value = '';
                        // 文字輸入框的重置也最好通知一下，以防萬一
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });

    // 清除頂部的 header 欄位
    document.getElementById("survey-number").value = '';
    document.getElementById("machine-number").selectedIndex = 0;
    document.getElementById("respondent-type").selectedIndex = 0;
    document.getElementById("flow-three").selectedIndex = 0;
    
    // 清除所有未填寫的紅色提醒框
    const unansweredElements = document.querySelectorAll('.unanswered');
    unansweredElements.forEach(el => el.classList.remove('unanswered'));
}
        
        function getFormData() {
            let result = "";
            const headerFields = {
                "問卷編號": document.getElementById("survey-number").value.trim(),
                "主機": document.getElementById("machine-number").value.trim(),
                "受訪者": document.getElementById("respondent-type").value.trim(),
                "分流三": document.getElementById("flow-three").value.trim()
            };

            result += `受訪者：${headerFields["受訪者"]}\n`;
            result += `---\n`;

            categories.forEach((category, catIndex) => {
                let categoryContent = "";
                const categoryElement = document.querySelector(`#cat-${catIndex}`);
                if (!categoryElement) return;

                category.questions.forEach((question, qIndex) => {
                    const qElement = categoryElement.querySelector(`#q-${question.title.replace(/[\s\/\(\)]/g, "")}-${qIndex}`);
                    if (!qElement) return;

                    const titlePrefix = `（${chineseNumbers[qIndex]}）${question.title}`;
                    let mainAnswerText = "";
                    let finalOutput = "";

                    if (question.type === "input-only" || question.type === "textarea-only") {
                        const inputElement = qElement.querySelector("input, textarea");
                        if (inputElement && inputElement.value.trim()) {
                            mainAnswerText = inputElement.value.trim();
                        }
                    } else {
                        mainAnswerText = parseAnswersFromContainer(qElement.querySelector('.options-container'));
                    }

                    if (mainAnswerText) {
                        // 步驟 2: 建立包含主答案的第一行
                        finalOutput = `${titlePrefix}：${mainAnswerText}`;

                        const subContentContainer = qElement.querySelector(".sub-content-container:not(.hidden)");
                        if (subContentContainer) {
                            const subAnswersString = parseSubQuestionsRecursively(subContentContainer);
                            
                            if (subAnswersString) {
                                finalOutput += subAnswersString;
                            }
                        }
                    }

                    if (finalOutput) {
                        categoryContent += `${finalOutput}\n\n`;
                    }
                });

                if (categoryContent) {
                    result += `${category.title}\n${categoryContent}`;
                }
            });

            return result;
        }

        function parseSubQuestionsRecursively(container, indent = '  ') {
            if (!container) return "";

            const directChildQuestionCards = Array.from(container.querySelectorAll(':scope > .question-card'));
            let outputString = "";
            
            const answeredCardsInfo = directChildQuestionCards.map(card => {
                const title = card.querySelector('h3').textContent.trim();
                const optionsDiv = card.querySelector(':scope > .options-container');
                const answer = parseAnswersFromContainer(optionsDiv);
                const subContainer = card.querySelector('.sub-content-container:not(.hidden)');
                return { card, title, answer, subContainer };
            }).filter(info => info.answer);

            answeredCardsInfo.forEach((info, index) => {
                const isLast = index === answeredCardsInfo.length - 1;
                const prefix = isLast ? '└' : '├';

                outputString += `\n${indent}${prefix} ${info.title}：${info.answer}`;
                
                if (info.subContainer) {
                    // 傳入子容器，並增加下一層的縮排
                    outputString += parseSubQuestionsRecursively(info.subContainer, indent + '  ');
                }
            });

            return outputString;
        }

        function getQuestionData(questionCard, question) {
            if (!questionCard || !question) return "";

            if (question.type === 'multiple-choice' || question.type === 'single-choice') {
                const checkedInputs = Array.from(questionCard.querySelectorAll(':scope > .options-container > .option > input:checked'));
                return checkedInputs.map(getOptionText).join("、");
            }
            return "";
        }

        // 表單驗證功能
        function validateForm() {
            const unansweredQuestions = [];
            document.querySelectorAll('.unanswered').forEach(el => el.classList.remove('unanswered')); // 清除先前的標記

            const headerInputs = [
                document.getElementById('survey-number')
            ];

            headerInputs.forEach(input => {
                if (input.value.trim() === '') {
                    unansweredQuestions.push(`（標頭）${input.closest('label').textContent.split(':')[0]}`);
                    input.classList.add('unanswered');
                }
            });

            categories.forEach((category, catIndex) => {
                category.questions.forEach((question, qIndex) => {
                    const qElement = document.querySelector(`#q-${question.title.replace(/[\s\/\(\)]/g, "")}-${qIndex}`);
                    if (!qElement) return;

                    let isAnswered = false;

                    if (question.type === "input-only" || question.type === "textarea-only") {
                        const inputElement = qElement.querySelector("input, textarea");
                        if (inputElement && inputElement.value.trim() !== '') {
                            isAnswered = true;
                        }
                    } else {
                        const checkedOptions = Array.from(qElement.querySelectorAll('input:checked'));
                        if (checkedOptions.length > 0) {
                            isAnswered = true;
                            // 檢查有條件輸入的選項
                            checkedOptions.forEach(input => {
                                const conditionalInput = input.closest('label').querySelector('.conditional-input');
                                if (conditionalInput && conditionalInput.style.display === 'block' && conditionalInput.value.trim() === '') {
                                    unansweredQuestions.push(`（${question.title}）請填寫補充說明`);
                                    conditionalInput.classList.add('unanswered');
                                }
                            });
                        }

                        // 檢查巢狀子題目
                        const subContentContainer = qElement.querySelector('.sub-content-container');
                        if (subContentContainer && subContentContainer.style.display !== "none") {
                            const subQuestions = subContentContainer.querySelectorAll('.question-card');
                            subQuestions.forEach(subQ => {
                                const subInputs = subQ.querySelectorAll('input, textarea');
                                let isSubAnswered = false;
                                subInputs.forEach(subInput => {
                                    if ((subInput.type === 'text' || subInput.tagName === 'TEXTAREA') && subInput.value.trim() !== '') {
                                        isSubAnswered = true;
                                    } else if ((subInput.type === 'radio' || subInput.type === 'checkbox') && subInput.checked) {
                                        isSubAnswered = true;
                                    }
                                });

                                if (!isSubAnswered) {
                                    unansweredQuestions.push(`（${question.title}）下的「${subQ.querySelector('h3 .title-text').textContent}」`);
                                    subQ.classList.add('unanswered');
                                }
                            });

                            // 檢查照顧者模板
                            const caregiverTemplate = subContentContainer.querySelector('.caregiver-template');
                            if (caregiverTemplate) {
                                const inputs = caregiverTemplate.querySelectorAll('input');
                                const hasCaregiverData = Array.from(inputs).some(input => input.value.trim() !== '');
                                if (!hasCaregiverData) {
                                    unansweredQuestions.push(`（${question.title}）下的「照顧者資料」`);
                                    caregiverTemplate.classList.add('unanswered');
                                }
                            }
                        }
                    }
                    
                    if (!isAnswered) {
                        unansweredQuestions.push(`（${category.title}）${question.title}`);
                        qElement.classList.add('unanswered');
                    }
                });
            });

            if (unansweredQuestions.length > 0) {
                const message = `尚有以下項目未填寫：\n\n- ${unansweredQuestions.join('\n- ')}\n\n請填寫完成後再嘗試。`;
                alert(message);
                const firstUnanswered = document.querySelector('.unanswered');
                if (firstUnanswered) {
                    firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            } else {
                alert("所有項目都已填寫完成！");
                return true;
            }
        }

        function generateForm() {
            categories.forEach((category, catIndex) => {
                const categoryDiv = document.createElement("div");
                categoryDiv.className = "category-group";
                categoryDiv.id = `cat-${catIndex}`;
                categoryDiv.innerHTML = `<h2>${category.title}</h2>`;

                category.questions.forEach((question, qIndex) => {
                    createQuestionElement(question, qIndex, categoryDiv);
                });

                formContainer.appendChild(categoryDiv);
            });
        }

        function createMobilitySelect() {
            const select = document.createElement('select');
            select.name = 'mobility-select';
            select.style.marginLeft = '10px';
            select.disabled = true;

            const defaultOption = document.createElement('option');
            defaultOption.value = "請選擇";
            defaultOption.textContent = "請選擇";
            select.appendChild(defaultOption);

            mobilityOptions.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                select.appendChild(option);
            });
            return select;
        }

        function updateMobilityOptions(container) {
            if (!container) return;

            const sourceCheckboxes = Array.from(container.querySelectorAll('input[name^="assistive-devices-list"]:checked'));
            const indoorMobilityCard = Array.from(container.querySelectorAll('.question-card h3')).find(h3 => h3.textContent.includes('居家／熟悉環境'));
            const outdoorMobilityCard = Array.from(container.querySelectorAll('.question-card h3')).find(h3 => h3.textContent.includes('戶外移動方式'));

            if (!indoorMobilityCard || !outdoorMobilityCard) return;

            const indoorOptionsContainer = indoorMobilityCard.nextElementSibling;
            const outdoorOptionsContainer = outdoorMobilityCard.nextElementSibling;

            // 清空舊的所有選項
            indoorOptionsContainer.innerHTML = '';
            outdoorOptionsContainer.innerHTML = '';
            
            // ⭐【核心升級】: 建立一個更強大的選項生成器 (內部輔助函式)
            const createMobilityOption = (deviceName, namePrefix) => {
                const label = document.createElement('label');
                label.className = 'option';
                
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = `${namePrefix}-${deviceName.replace(/\s/g, '')}`; // 移除deviceName中的空格以確保name有效
                checkboxInput.value = deviceName;
                
                const select = document.createElement('select');
                
                // ⭐【需求 2】: 預設為停用狀態 (灰色、無法點擊)
                select.disabled = true;
                
                const defaultSelectOption = document.createElement('option');
                defaultSelectOption.textContent = '請選擇';
                select.appendChild(defaultSelectOption);
                
                mobilityOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
                
                // ⭐【需求 3】: 綁定事件，點擊 checkbox 來啟用/停用 select
                checkboxInput.addEventListener('change', () => {
                    if (checkboxInput.checked) {
                        select.disabled = false; // 啟用 select
                    } else {
                        select.disabled = true;  // 停用 select
                        select.selectedIndex = 0; // 如果取消勾選，重置 select 的選項
                    }
                });
                
                label.appendChild(checkboxInput);
                label.append(` ${deviceName} `);
                label.appendChild(select);
                
                return label;
            };
            
            // ⭐【需求 1】: 為 "不使用輔具" 也使用新的生成器，讓它也擁有 select
            indoorOptionsContainer.appendChild(createMobilityOption('不使用輔具', 'indoor-mobility'));
            outdoorOptionsContainer.appendChild(createMobilityOption('不使用輔具', 'outdoor-mobility'));

            // 根據來源 checkbox，動態生成其他的輔具選項
            sourceCheckboxes.forEach(checkbox => {
                const deviceName = checkbox.value;
                indoorOptionsContainer.appendChild(createMobilityOption(deviceName, 'indoor-mobility'));
                outdoorOptionsContainer.appendChild(createMobilityOption(deviceName, 'outdoor-mobility'));
            });
        }

        function createMobilityOptionElement(questionCardId, value, isChecked = false) {
    const label = document.createElement("label");
    label.className = "option";

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = `${questionCardId}-devices`; 
    checkbox.value = value;
    checkbox.checked = isChecked;

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(value));

    const select = createMobilitySelect();
    select.disabled = !isChecked; // 初始化時根據是否勾選來禁用
    label.appendChild(select);

    return label;
}

        document.addEventListener("DOMContentLoaded", () => {
            generateForm();

            // 小工具和主題的下拉式選單功能
            const toolsToggleBtn = document.getElementById("tools-toggle");
            const toolsDropdown = document.getElementById("tools-dropdown");
            const themeToggleBtn = document.querySelector("#theme-tools button");
            const themeDropdown = document.getElementById("theme-dropdown");
            const validateBtn = document.getElementById("validate-btn");

            toolsToggleBtn.addEventListener("click", (event) => {
                event.stopPropagation(); // 阻止事件冒泡到 document
                toolsDropdown.classList.toggle("active");
                themeDropdown.classList.remove("active"); // 確保子選單在父選單關閉時一併關閉
            });

            themeToggleBtn.addEventListener("click", (event) => {
                event.stopPropagation(); // 阻止事件冒泡到 toolsToggleBtn
                themeDropdown.classList.toggle("active");
            });

            // 點擊工具區塊以外的地方，隱藏所有下拉式選單
            document.addEventListener("click", (event) => {
                const isClickInsideTools = toolsDropdown.contains(event.target) || toolsToggleBtn.contains(event.target);
                if (!isClickInsideTools && toolsDropdown.classList.contains("active")) {
                    toolsDropdown.classList.remove("active");
                }
            });

            // 按鈕事件監聽器
            document.getElementById("theme-beige").addEventListener("click", () => {
                switchTheme('beige');
                toolsDropdown.classList.remove("active"); // 切換後自動關閉選單
            });

            document.getElementById("theme-green").addEventListener("click", () => {
                switchTheme('green');
                toolsDropdown.classList.remove("active");
            });

            document.getElementById("theme-gray").addEventListener("click", () => {
                switchTheme('gray');
                toolsDropdown.classList.remove("active");
            });

            // 檢查未填寫項目按鈕的事件
            validateBtn.addEventListener("click", () => {
                validateForm();
                toolsDropdown.classList.remove("active");
            });

            document.getElementById("copy-btn").addEventListener("click", () => {
                const content = getFormData();
                if (content) {
                    navigator.clipboard.writeText(content).then(() => {
                        alert("內容已複製！");
                    }).catch(err => {
                        alert("複製失敗，請手動複製！錯誤：" + err);
                    });
                } else {
                    alert("沒有可複製的內容。");
                }
            });

            document.getElementById("download-btn").addEventListener("click", () => {
                const surveyNumber = document.getElementById("survey-number").value || "未填寫";
                const machineNumber = document.getElementById("machine-number").value || "未填寫";
                const respondentType = document.getElementById("respondent-type").value || "未填寫";
                const flowThree = document.getElementById("flow-three").value || "未填寫";

                const filename = `${surveyNumber}-主機${machineNumber}-${respondentType}-分流三(${flowThree}).txt`;
                const content = getFormData();
                if (content) {
                    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                } else {
                    alert("沒有可下載的內容。");
                }
            });

            document.getElementById("clear-btn").addEventListener("click", clearForm);
        });
    </script>
</body>
</html>