<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICFé›»è¨ªå•å·</title>
    <style>
        :root {
            --body-bg: #eef1f4;
            --container-bg: #f7f9fb;
            --container-shadow: rgba(0, 0, 0, 0.05);
            --header-bg: rgba(247, 249, 251, 0.95);
            --header-shadow: rgba(0, 0, 0, 0.05);
            --text-color-primary: #4a4a4a;
            --text-color-secondary: #5c5c5c;
            --border-color: #dcdfe3;
            --button-bg: #6c757d;
            --button-hover-bg: #5a6268;
            --dropdown-bg: #f7f9fb;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: var(--body-bg);
            padding-top: 100px;
            color: var(--text-color-secondary);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px var(--container-shadow);
        }

        h1, h2, h3 {
            color: var(--text-color-primary);
        }

        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 30px;
        }

        #sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--header-bg);
            box-shadow: 0 2px 5px var(--header-shadow);
            z-index: 1000;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #header-fields {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        #actions {
            display: flex;
            gap: 10px;
        }

        /* å·¢ç‹€ä¸‹æ‹‰å¼é¸å–®æ¨£å¼ */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none; /* é è¨­éš±è— */
            position: absolute;
            top: 100%; /* åœ¨æŒ‰éˆ•ä¸‹æ–¹é¡¯ç¤º */
            right: 0;
            background-color: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            padding: 5px;
            z-index: 999;
            white-space: nowrap;
            flex-direction: column;
            gap: 5px;
        }
        
        .dropdown-content.active {
            display: flex; /* é»æ“Šå¾Œé¡¯ç¤º */
        }

        .dropdown-content .dropdown-content {
            top: 0; /* å­é¸å–®èˆ‡çˆ¶é¸å–®å°é½Š */
            right: 100%; /* å­é¸å–®åœ¨çˆ¶é¸å–®å·¦å´ */
            padding: 5px;
            margin-right: 5px;
        }

        .dropdown-content button {
            width: 100%;
            text-align: left;
        }
        
        .question-card {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .question-card h3 {
            flex-shrink: 0;
            width: 180px;
            margin: 0;
            padding-right: 10px;
            color: var(--text-color-primary);
            font-size: 1em;
            line-height: 1.5;
            display: flex;
        }

        .question-card h3 .title-prefix {
            flex: 0 0 auto;
        }

        .question-card h3 .title-text {
            flex: 1;
            flex-wrap: wrap;
        }

        .options-container {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            line-height: 1.5;
        }

        .option {
            display: inline-flex;
            align-items: flex-start;
            margin-right: 15px;
            margin-bottom: 5px;
            cursor: pointer;
            padding: 2px 0;
            color: var(--text-color-secondary);
        }

        .option input[type="radio"],
        .option input[type="checkbox"] {
            margin-right: 5px;
            position: relative;
            top: 2px;
        }

        .conditional-input {
            margin-left: 10px;
            padding: 3px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9em;
        }

        .full-width-input,
        .full-width-textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .full-width-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .sub-content-container {
            width: 100%;
            padding-left: 20px;
            margin-top: 10px;
            border-left: 2px solid var(--border-color);
            transition: all 0.3s ease-in-out; 
        }

        .sub-content-container.hidden {
            display: none !important; 
        }

        .caregiver-template label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
            color: var(--text-color-secondary);
        }

        .caregiver-template input {
            width: auto;
            margin-left: 5px;
        }

        #actions button {
            padding: 10px 15px;
            border: none;
            background-color: var(--button-bg);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        #actions button:hover {
            background-color: var(--button-hover-bg);
        }

        .unanswered {
            outline: 2px solid red;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .murmur{
            font-size: 15px;
            font-weight: 100;
        }

        /* æ‡¸æµ®æŒ‰éˆ•æ¨£å¼ */
        .welfare-float-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            background-color: #4CAF50; /* ç¶ è‰²ï¼Œå¯ä¾å–œå¥½ä¿®æ”¹ */
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        .welfare-float-btn:hover {
            transform: scale(1.05);
            background-color: #45a049;
        }

        /* å´é‚Šæ¬„æ¨£å¼ */
        .welfare-sidebar {
            position: fixed;
            top: 0;
            right: -400px; /* é è¨­éš±è—åœ¨å³å´è¢å¹•å¤– */
            width: 350px; /* å´é‚Šæ¬„å¯¬åº¦ */
            height: 100vh;
            background-color: #f9f9f9;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 10000; /* æ¯”æŒ‰éˆ•æ›´é«˜ */
            transition: right 0.3s ease-in-out; /* æ»‘å‹•å‹•ç•« */
            display: flex;
            flex-direction: column;
            font-family: sans-serif;
        }

        /* å´é‚Šæ¬„é–‹å•Ÿæ™‚çš„ç‹€æ…‹ */
        .welfare-sidebar.open {
            right: 0;
        }

        /* å´é‚Šæ¬„å…§éƒ¨æ’ç‰ˆ */
        .sidebar-header {
            padding: 15px;
            background-color: #333;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar-search {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .sidebar-search input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .sidebar-content {
            flex-grow: 1;
            overflow-y: auto; /* è®“å…§å®¹å¯ä»¥æ²å‹• */
            padding: 10px;
        }

        /* çµæœå¡ç‰‡æ¨£å¼ */
        .welfare-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .welfare-card h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .welfare-card p {
            margin: 3px 0;
            font-size: 14px;
            color: #555;
        }

        .welfare-tag {
            display: inline-block;
            background: #e0f7fa;
            color: #006064;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }

        .loading-text {
            text-align: center;
            color: #888;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="sticky-header">
        <div id="header-fields">
            <label>å•å·ç·¨è™Ÿ: <input type="text" id="survey-number" placeholder="è«‹å¡«å¯«"></label>
            <label>ä¸»æ©Ÿ:
                <select id="machine-number">
                    <option value="ä¸€">ä¸€</option>
                    <option value="äºŒ">äºŒ</option>
                    <option value="ä¸‰">ä¸‰</option>
                    <option value="å››">å››</option>
                    <option value="äº”">äº”</option>
                    <option value="å…­">å…­</option>
                    <option value="æœªå­˜æª”">æœªå­˜æª”</option>
                </select>
            </label>
            <label>å—è¨ªè€…:
                <select id="respondent-type">
                    <option value="æœ¬äºº">æœ¬äºº</option>
                    <option value="ä¸»è¦ç…§é¡§è€…">ä¸»è¦ç…§é¡§è€…</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </label>
            <label>åˆ†æµä¸‰:
                <select id="flow-three">
                    <option value="å¦">å¦</option>
					<option value="åˆæ¬¡ç”³è«‹ä¸”éå°±å­¸éå°±æ¥­è€…">åˆæ¬¡ç”³è«‹ä¸”éå°±å­¸éå°±æ¥­è€…</option>
					<option value="èº«2">èº«2</option>
					<option value="ç¨å±…èº«éšœè€…">ç¨å±…èº«éšœè€…</option>
					<option value="ç”³è«‹èº«æ¬Šæ³•50ã€51æ¢ä¹‹ç¦åˆ©æœå‹™è€…">ç”³è«‹èº«æ¬Šæ³•50ã€51æ¢ä¹‹ç¦åˆ©æœå‹™è€…</option>
					<option value="å…¨æ—¥å‹ä½å®¿å¼">å…¨æ—¥å‹ä½å®¿å¼æ¡ˆä»¶</option>
					<option value="åš´é‡æƒ…ç·’è¡Œç‚º">åš´é‡æƒ…ç·’è¡Œç‚º</option>
					<option value="é«˜ç…§é¡§è² è·">é«˜ç…§é¡§è² è·</option>
					<option value="é€šå ±ç¤¾å®‰ç¶²">é€šå ±ç¤¾å®‰ç¶²</option>
					<option value="è‡ªæ®ºé€šå ±">è‡ªæ®ºé€šå ±</option>
                </select>
            </label>
        </div>
        <div id="actions">
            <div id="tools-area" class="dropdown">
                <button id="tools-toggle">å°å·¥å…·</button>
                <div id="tools-dropdown" class="dropdown-content">
                    <div id="theme-tools" class="dropdown">
                        <button>é¡è‰²</button>
                        <div id="theme-dropdown" class="dropdown-content">
                            <button id="theme-beige">ç±³ç™½</button>
                            <button id="theme-green">æ·¡ç¶ </button>
                            <button id="theme-gray">æ·ºç°</button>
                        </div>
                    </div>
                    <button id="validate-btn">æª¢æŸ¥æœªå¡«å¯«é …ç›®</button>
                </div>
            </div>
            <button id="copy-btn">è¤‡è£½å…§å®¹</button>
            <button id="download-btn">ä¸‹è¼‰æª”æ¡ˆ</button>
            <button id="clear-btn">æ¸…é™¤è¡¨å–®</button>
        </div>
    </div>

    <div class="container">
        <h2>é›»è¨ªå•å·<br>
        <span class="murmur">2025.9.11è·Ÿé•·ç…§æ‰€é–‹å®Œæœƒå¾Œä¿®æ”¹çš„ç‰ˆæœ¬</span><br>
        <span class="murmur">2025.11.3è®Šæ›´é¡Œç›®é¡¯ç¤ºé‚è¼¯</span></h2>
        <form id="survey-form"></form>
    </div>

    <button id="welfare-toggle-btn" class="welfare-float-btn">
        ğŸ” ç¦åˆ©æŸ¥è©¢
    </button>

    <div id="welfare-sidebar" class="welfare-sidebar">
        <div class="sidebar-header">
            <h3>èº«å¿ƒéšœç¤™ç¦åˆ©è³‡æ–™åº«</h3>
            <button id="welfare-close-btn" class="close-btn">&times;</button>
        </div>
        
        <div class="sidebar-search">
            <input type="text" id="welfare-search-input" placeholder="è¼¸å…¥é—œéµå­—æœå°‹ (ä¾‹å¦‚: è¼ªæ¤…)...">
        </div>

        <div class="sidebar-content">
            <div id="welfare-results-container">
                <div class="loading-text">è³‡æ–™è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
    <script>
        // =========================
        // è³‡æ–™çµæ§‹èˆ‡è®Šæ•¸
        // =========================
        const categories = [
            {
                title: "ä¸€ã€å€‹æ¡ˆæ¦‚æ³",
                questions: [
                    {
                        title: "èªçŸ¥èƒ½åŠ›",
                        type: "multiple-choice",
                        options: ["ç„¡å›°é›£", "å¯è½æ‡‚ç°¡å–®æŒ‡ä»¤", "ç­”éæ‰€å•", "æ™‚å¥½æ™‚å£", "æ··äº‚", "çŸ­æœŸè¨˜æ†¶é€€åŒ–", "åƒ…çœ¨çœ¼ã€ç„¡æ³•åˆ¤å®š", "å¤§è²èªªè©±æ‰å¯ç†è§£","å¯éƒ¨åˆ†è¾¨èªå‡ºå®¶äºº","å®Œå…¨èªä¸å‡ºäºº", { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "ç²¾ç¥ç‹€æ³",
                        type: "multiple-choice",
                        options: ["æƒ…ç·’ç©©å®š", "æƒ…ç·’ä¸ç©©å®š", "å¹»è½ã€å¹»è¦º", "å¦„æƒ³", "è„«åºè¡Œç‚º", "äººéš›é€€ç¸®", "æ—¥å¤œé¡›å€’", "å—œç¡", { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "è¡¨é”åŠŸèƒ½",
                        type: "multiple-choice",
                        options: ["ç„¡å›°é›£", "å¯ä½¿ç”¨ç°¡å–®å­—å¥", "ä¸€å•ä¸€ç­”", "åªç”¨å–®å­—ï¼è©å›å¾©", "é®®å°‘é–‹å£", "æ§‹éŸ³ä¸æ¸…", "ä»¿èªª", "èªªè©±ç·©æ…¢", "ç„¡æ³•è¨€èª", "ä½¿ç”¨è‚¢é«”å›æ‡‰","ç”¨æ‰‹å¯«å›æ‡‰", "æœƒå›ç­”ã€Œæ˜¯ä¸æ˜¯ã€ã€ã€Œå¥½ä¸å¥½ã€ã€ã€Œè¦ä¸è¦ã€ç­‰æ˜¯éé¡Œ", { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "è‚¢é«”éšœç¤™",
                        type: "multiple-choice",
                        options: ["ç„¡å›°é›£", "å·¦ä¸Šè‚¢", "å³ä¸Šè‚¢", "é›™ä¸Šè‚¢", "å·¦ä¸‹è‚¢", "å³ä¸‹è‚¢", "é›™ä¸‹è‚¢","è„Šæ¤", "å…¨ç™±", { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "è¡Œå‹•èƒ½åŠ›",
                        type: "multiple-choice",
                        options: ["ç„¡å›°é›£ï¼ˆå°æ–¼5%ï¼‰", "å¾ˆå°‘æœ‰å›°é›£ï¼ˆ5%-25%ï¼‰", "å¶çˆ¾æœ‰å›°é›£ï¼ˆ25%-50%ï¼‰", "ç¶“å¸¸æœ‰å›°é›£ï¼ˆ50%-95%ï¼‰", "ç„¡æ³•è¡Œèµ°ï¼ˆå¤§æ–¼95%ï¼‰","å®¹æ˜“ç–²å€¦", "é‡å¿ƒä¸ç©©ã€åç§»", "å°ç¢æ­¥", "æ‹–æ­¥", "è·›è¡Œ", { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "è¼”å…·ä½¿ç”¨",
                        type: "single-choice",
                        options: [
                            { 
                                text: "ç„¡",
                                subQuestions:[
                                    {
                                        title: "å±…å®¶ï¼ç†Ÿæ‚‰ç’°å¢ƒçš„ç§»å‹•æ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["ä¸ä½¿ç”¨è¼”å…·"],
                                    },
                                    {
                                        title: "æˆ¶å¤–ç§»å‹•æ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["ä¸ä½¿ç”¨è¼”å…·"],
                                    },
                                ]
                            },
                            {
                                text: "æœ‰", 
                                subQuestions:[
                                    {
                                        title: "ç›®å‰æœ‰ä½¿ç”¨çš„è¼”å…·",
                                        type: "multiple-choice",
                                        name: "assistive-devices-list",
                                        options: ["å–®æ‹", "å››è…³æ‹", "é›¨å‚˜æ‹", "åŠ©è¡Œå™¨", "åŠ©æ­¥è»Š", "è¼ªæ¤…", "é›»å‹•è¼ªæ¤…", "é›»å‹•ä»£æ­¥è»Š", "åŠ©è½å™¨", "ä¾¿ç›†æ¤…", "æ²æµ´æ¤…", "æ°£å¢ŠåºŠå¢Š", "ç—…åºŠ","é›»å‹•åºŠ", { text: "å…¶ä»–", hasInputField: true }],
                                    },
                                    {
                                        title: "å±…å®¶ï¼ç†Ÿæ‚‰ç’°å¢ƒçš„ç§»å‹•æ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["ä¸ä½¿ç”¨è¼”å…·"],
                                    },
                                    {
                                        title: "æˆ¶å¤–ç§»å‹•æ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["ä¸ä½¿ç”¨è¼”å…·"],
                                    },
                                ],
                            },
                        ],
                    },
                    {
                        title: "æˆ¶å¤–ç§»å‹•æ¨£æ…‹",
                        type: "input-only",
                    },
                    {
                        title: "è¿‘æœŸç¢°æ’ï¼è·Œå€’ç‹€æ³",
                        type: "single-choice",
                        options: ["ç„¡", "æœ‰"],
                    },
                    {
                        title: "ç”Ÿæ´»è‡ªç†",
                        type: "single-choice",
                        options: [
                            "å¯è‡ªç†",
                            {
                                text: "éƒ¨åˆ†é ˆå”åŠ©",
                                subQuestions:[
                                    {
                                        title: "å”åŠ©è€…",
                                        type: "multiple-choice",
                                        options: ["å®¶äºº", "çœ‹è­·ï¼å¤–ç±çœ‹è­·", "å±…æœå“¡", "æ©Ÿæ§‹ç…§æœå“¡", { text: "å…¶ä»–", hasInputField: true }],
                                    },
                                    {
                                        title: "é€²é£Ÿæ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["è‡ªè¡Œä½¿ç”¨é¤å…·", "ä»–äººé¤µé£Ÿ", "ç®¡çŒ","ç‡Ÿé¤Šè¼¸æ¶²æ³¨å°„"],
                                    },
                                    {
                                        title: "å¦‚å»ç‹€æ³",
                                        type: "single-choice",
                                        options: ["ä¸é ˆå®åš€", "é ˆå®åš€","éƒ¨ä»½å”åŠ©", "å°¿å¸ƒ", "å°¿ç®¡"],
                                    },
                                    {
                                        title: "æ²æµ´æ–¹å¼",
                                        type: "single-choice",
                                        options: ["ä¸é ˆå®åš€", "é ˆå®åš€","éƒ¨ä»½å”åŠ©",  "ä»–äººå”åŠ©"],
                                    },
                                    {
                                        title: "ç©¿è„«è¡£æœ",
                                        type: "single-choice",
                                        options: ["è‡ªç†", "ä»–äººå”åŠ©", "å®Œå…¨ä¾è³´ä»–äºº"],
                                    },
                                ],
                            },
                            {
                                text: "å®Œå…¨ä»°è³´ä»–äºº",
                                subQuestions:[
                                    {
                                        title: "å”åŠ©è€…",
                                        type: "multiple-choice",
                                        options: ["å®¶äºº", "çœ‹è­·ï¼å¤–ç±çœ‹è­·", "å±…æœå“¡", "æ©Ÿæ§‹ç…§æœå“¡", { text: "å…¶ä»–", hasInputField: true }],
                                    },
                                    {
                                        title: "é€²é£Ÿæ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["ä»–äººé¤µé£Ÿ", "ç®¡çŒ","ç‡Ÿé¤Šè¼¸æ¶²æ³¨å°„"],
                                    },
                                    {
                                        title: "å¦‚å»ç‹€æ³",
                                        type: "multiple-choice",
                                        options: ["éƒ¨ä»½å”åŠ©", "å°¿å¸ƒ", "å°¿ç®¡"],
                                    },
                                    {
                                        title: "æ²æµ´æ–¹å¼",
                                        type: "single-choice",
                                        options: ["éƒ¨ä»½å”åŠ©",  "ä»–äººå”åŠ©"],
                                    },
                                    {
                                        title: "ç©¿è„«è¡£æœ",
                                        type: "single-choice",
                                        options: ["ä»–äººéƒ¨åˆ†å”åŠ©", "å®Œå…¨ä¾è³´ä»–äºº"],
                                    },
                                ],
                            },
                        ],
                    },
                    {
                        title: "å°±é†«æƒ…å½¢",
                        type: "single-choice",
                        options: ["å®šæœŸå°±é†«" , "ç”Ÿç—…å»é•·æœŸæœªå°±é†«", "æœ‰éœ€æ±‚æ™‚å†å»","å±…å®¶é†«ç™‚" , { text: "å…¶ä»–ï¼è£œå……èªªæ˜", hasInputField: true }],
                    },
                    {
                        title: "å°±æ¥­ç‹€æ³",
                        type: "single-choice",
                        options: ["ç„¡", { text: "å°±æ¥­ä¸­", hasInputField: true }, { text: "å°±å­¸ä¸­", hasInputField: true }, "é€€ä¼‘", { text: "å…¶ä»–", hasInputField: true }],
                    },
                    {
                        title: "äº¤é€šèƒ½åŠ›",
                        type: "single-choice",
                        options: [
                            "ç„¡",
                            { 
                                text: "æœ‰",
                                subQuestions: [
                                    {
                                        title: "äº¤é€šæ–¹å¼",
                                        type: "multiple-choice",
                                        options: ["æ­ä¹˜å¤§çœ¾é‹è¼¸å·¥å…·", "è‡ªè¡Œé–‹è»Šï¼é¨æ©Ÿè»Šï¼è…³è¸è»Šï¼é›»å‹•ä»£æ­¥è»Š", "å¾©åº·å·´å£«", "é•·ç…§äº¤é€šè»Š", "è¨ˆç¨‹è»Š", "æ©Ÿæ§‹è»Š", "å®¶äººæ¥é€", "éœ€é™ªä¼´", "ä¸é ˆé™ªä¼´", { text: "å…¶ä»–", hasInputField: true }],
                                    },
                                ]
                            }
                        ],
                    },
                    {
                        title: "å±…ä½ç‹€æ³",
                        type: "single-choice",
                        options: ["ç¨å±…", "èˆ‡å®¶äººè¦ªå‹ï¼ˆæˆ–å¤–çœ‹ï¼‰åŒä½", { text: "å…¥ä½æ©Ÿæ§‹", hasInputField: true }, { text: "å…¶ä»–", hasInputField: true }],
                    },
                    {
                        title: "ä½¿ç”¨é•·ç…§æœå‹™",
                        type: "single-choice",
                        options: [
                            "ç„¡",
                            {
                                text: "æœ‰", 
                                subQuestions: [ 
                                    {
                                        title: "æœå‹™é …ç›®", 
                                        type: "multiple-choice",
                                        options: [
                                            {
                                                text: "å±…å®¶æœå‹™",
                                                subQuestions: [ 
                                                    {
                                                        title: "å±…å®¶æœå‹™ç´°é …",
                                                        type: "multiple-choice",
                                                        options: ["æ²æµ´", "å‚™é¤", "é™ªä¼´æœå‹™", "é™ªåŒå¤–å‡º", { text: "å…¶ä»–", hasInputField: true }]
                                                    }
                                                ]
                                            },
                                            { text: "æ—¥ç…§ä¸­å¿ƒ", hasInputField: true },
                                            "æ©Ÿæ§‹å–˜æ¯",
                                            "äº¤é€šè»Š",
                                            { text: "å…¶ä»–", hasInputField: true }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                ],
            },
            {
                title: "äºŒã€å®¶åº­æ¦‚æ³",
                questions: [
                    {
                        title: "å®¶åº­æˆå“¡åŠå½¼æ­¤é—œä¿‚",
                        type: "textarea-only",
                    },
                    {
                        title: "ä¸»è¦ç…§é¡§è€…",
                        type: "single-choice",
                        options: [
                            "ç„¡", 
                            { 
                                text: "æœ‰", 
                                subQuestions: [
                                    {
                                        title: "ç…§é¡§è€…å§“å",
                                        type: "input-only"
                                    },
                                    {
                                        title: "ç…§é¡§è€…å¹´ç´€",
                                        type: "input-only"
                                    },
                                    {
                                        title: "èˆ‡è¢«ç…§é¡§è€…çš„é—œä¿‚",
                                        type: "input-only"
                                    },
                                    {
                                        title: "ç…§é¡§è€…æ˜¯å¦ç‚ºèº«å¿ƒéšœç¤™è€…",
                                        type: "single-choice",
                                        options: [
                                            "å¦", 
                                            {
                                                text: "æ˜¯",
                                                subQuestions: [ 
                                                    {
                                                        title: "èº«å¿ƒéšœç¤™é¡åˆ¥",
                                                        type: "input-only",
                                                    },
                                                    {
                                                        title: "èº«é«”å¥åº·ç‹€æ³",
                                                        type: "input-only" 
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        title: "æ¬¡è¦ç…§é¡§è€…",
                        type: "single-choice",
                        options: [
                            "ç„¡", 
                            { 
                                text: "æœ‰", 
                                subQuestions: [
                                    {
                                        title: "ç…§é¡§è€…å§“å",
                                        type: "input-only"
                                    },
                                    {
                                        title: "ç…§é¡§è€…å¹´ç´€",
                                        type: "input-only"
                                    },
                                    {
                                        title: "èˆ‡è¢«ç…§é¡§è€…çš„é—œä¿‚",
                                        type: "input-only"
                                    },
                                    {
                                        title: "ç…§é¡§è€…æ˜¯å¦ç‚ºèº«å¿ƒéšœç¤™è€…",
                                        type: "single-choice",
                                        options: [
                                            "å¦", 
                                            {
                                                text: "æ˜¯",
                                                subQuestions: [ 
                                                    {
                                                        title: "èº«å¿ƒéšœç¤™é¡åˆ¥",
                                                        type: "input-only",
                                                    },
                                                    {
                                                        title: "èº«é«”å¥åº·ç‹€æ³",
                                                        type: "input-only" 
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        title: "ç¶“æ¿Ÿä¾†æº",
                        type: "multiple-choice",
                        options: [
                            {
                                text: "æœ‰ç©©å®šä¾†æº",
                                subQuestions:[
                                    {
                                        title: "é€€ä¼‘é‡‘",
                                        type: "multiple-choice",
                                        options: ["å‹é€€",ã€€"æ¼é€€", "å…¬é€€", "è¾²é€€", "æ¦®æ°‘é€€"]
                                    },
                                    {
                                        title: "ç¦åˆ©è£œåŠ©",
                                        type: "multiple-choice",
                                        options: ["èº«å¿ƒéšœç¤™è€…ç”Ÿæ´»è£œåŠ©", "èº«å¿ƒéšœç¤™è€…æ—¥é–“ç…§é¡§åŠä½å®¿å¼ç…§é¡§è²»ç”¨è£œåŠ©", "ä½å®¿å¼æœå‹™æ©Ÿæ§‹ä½¿ç”¨è€…è£œåŠ©æ–¹æ¡ˆ","ä½æ”¶ç”Ÿæ´»è£œåŠ©", "ä¸­ä½æ”¶è€äººç”Ÿæ´»æ´¥è²¼", "åœ‹æ°‘å¹´é‡‘", "è€äººå¹´é‡‘", "è€è¾²æ¼æ´¥è²¼"]
                                    },
                                ]
                            },
                            "å­˜æ¬¾",
                            { text: "å®¶äººç¶“æ¿Ÿæ´åŠ©", hasInputField: true },
                            { text: "å…¶ä»–", hasInputField: true },
                        ],
                    },
                ],
            },
            {
                title: "ä¸‰ã€è³‡æºä½¿ç”¨æƒ…æ³",
                questions: [
                    {
                        title: "å·²ä½¿ç”¨è³‡æº",
                        type: "multiple-choice",
                        options: ["èº«éšœè­‰æ˜è«‹é ˜è£œæ›", "è¿·å¤±æ‰‹éŠï¼Qå¸ƒæ¨™", "é•·ç…§æœå‹™", "ç‰Œç…§ç¨…æ¸›å…è£œåŠ©ã€å¥ä¿è²»åŠæ›è™Ÿè²»æ¸›å…", "è„†å®¶é€šå ±", "è‡ªæ®ºé€šå ±", { text: "å…¶ä»–", hasInputField: true }],
                    },
                    {
                        title: "å»ºè­°ä½¿ç”¨ï¼è³‡æºæä¾›èªªæ˜",
                        type: "multiple-choice",
                        options: ["èº«éšœè­‰æ˜è«‹é ˜è£œæ›", "è¿·å¤±æ‰‹éŠï¼Qå¸ƒæ¨™", "é•·ç…§æœå‹™", "ç‰Œç…§ç¨…æ¸›å…è£œåŠ©ã€å¥ä¿è²»åŠæ›è™Ÿè²»æ¸›å…", "è„†å®¶é€šå ±", "è‡ªæ®ºé€šå ±", { text: "å…¶ä»–", hasInputField: true }],
                    },
                    {
                        title: "å”åŠ©ç”³è«‹ï¼è½‰ä»‹",
                        type: "multiple-choice",
                        options: ["è¿·å¤±æ‰‹éŠï¼Qå¸ƒæ¨™", "é•·ç…§æœå‹™", "ç‰Œç…§ç¨…æ¸›å…è£œåŠ©ã€å¥ä¿è²»åŠæ›è™Ÿè²»æ¸›å…", "è„†å®¶é€šå ±", "è‡ªæ®ºé€šå ±", { text: "å…¶ä»–", hasInputField: true }],
                    },
                ],
            },
            {
                title: "å››ã€ç›®å‰æ‰€é‡å›°é›£æˆ–å¾…å”åŠ©éœ€æ±‚äº‹é …",
                questions: [
                    {
                        title: "ç›®å‰æ‰€é‡å›°é›£æˆ–å¾…å”åŠ©éœ€æ±‚äº‹é …",
                        type: "input-only",
                    },
                ],
            }
        ];

        const formContainer = document.getElementById("survey-form");
        const chineseNumbers = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå"];
        const mobilityOptions = ["ç¨ç«‹è¡Œèµ°", "æ‰¶è‘—å®¶å…·ï¼ç‰©å“ï¼ç‰†å£è¡Œèµ°", "éœ€è¦å®‰å…¨çœ‹è¦–", "ä»–äººæ”™æ‰¶", "ä»–äººæ¨è¡Œ"];
        const themes = {
            gray: {
                '--body-bg': '#eef1f4',
                '--container-bg': '#f7f9fb',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(247, 249, 251, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#4a4a4a',
                '--text-color-secondary': '#5c5c5c',
                '--border-color': '#dcdfe3',
                '--button-bg': '#6c757d',
                '--button-hover-bg': '#5a6268',
                '--dropdown-bg': '#f7f9fb',
            },
            beige: {
                '--body-bg': '#f8f5eb',
                '--container-bg': '#fffdf7',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(255, 253, 247, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#5d564f',
                '--text-color-secondary': '#4a453e',
                '--border-color': '#e0d9c4',
                '--button-bg': '#7f6e59',
                '--button-hover-bg': '#635647',
                '--dropdown-bg': '#fffdf7',
            },
            green: {
                '--body-bg': '#eaf1e7',
                '--container-bg': '#f8fcf7',
                '--container-shadow': 'rgba(0, 0, 0, 0.05)',
                '--header-bg': 'rgba(248, 252, 247, 0.95)',
                '--header-shadow': 'rgba(0, 0, 0, 0.05)',
                '--text-color-primary': '#4b6a5b',
                '--text-color-secondary': '#3f5e51',
                '--border-color': '#b3d9c7',
                '--button-bg': '#55998a',
                '--button-hover-bg': '#4a7d71',
                '--dropdown-bg': '#f8fcf7',
            }
        };

        // ===================================
        // ä½¿ç”¨è€…ä»‹é¢ (Global Settings & UI)
        // ===================================

        // è¡¨å–®é©—è­‰åŠŸèƒ½
        function validateForm() {
            const unansweredQuestions = [];
            document.querySelectorAll('.unanswered').forEach(el => el.classList.remove('unanswered')); // æ¸…é™¤å…ˆå‰çš„æ¨™è¨˜

            const headerInputs = [
                document.getElementById('survey-number')
            ];

            headerInputs.forEach(input => {
                if (input.value.trim() === '') {
                    unansweredQuestions.push(`ï¼ˆæ¨™é ­ï¼‰${input.closest('label').textContent.split(':')[0]}`);
                    input.classList.add('unanswered');
                }
            });

            categories.forEach((category, catIndex) => {
                category.questions.forEach((question, qIndex) => {
                    const qElement = document.querySelector(`#q-${question.title.replace(/[\s\/\(\)]/g, "")}-${qIndex}`);
                    if (!qElement) return;

                    let isAnswered = false;

                    if (question.type === "input-only" || question.type === "textarea-only") {
                        const inputElement = qElement.querySelector("input, textarea");
                        if (inputElement && inputElement.value.trim() !== '') {
                            isAnswered = true;
                        }
                    } else {
                        const checkedOptions = Array.from(qElement.querySelectorAll('input:checked'));
                        if (checkedOptions.length > 0) {
                            isAnswered = true;
                            // æª¢æŸ¥æœ‰æ¢ä»¶è¼¸å…¥çš„é¸é …
                            checkedOptions.forEach(input => {
                                const conditionalInput = input.closest('label').querySelector('.conditional-input');
                                if (conditionalInput && conditionalInput.style.display === 'block' && conditionalInput.value.trim() === '') {
                                    unansweredQuestions.push(`ï¼ˆ${question.title}ï¼‰è«‹å¡«å¯«è£œå……èªªæ˜`);
                                    conditionalInput.classList.add('unanswered');
                                }
                            });
                        }

                        // æª¢æŸ¥å·¢ç‹€å­é¡Œç›®
                        const subContentContainer = qElement.querySelector('.sub-content-container');
                        if (subContentContainer && subContentContainer.style.display !== "none") {
                            const subQuestions = subContentContainer.querySelectorAll('.question-card');
                            subQuestions.forEach(subQ => {
                                const subInputs = subQ.querySelectorAll('input, textarea');
                                let isSubAnswered = false;
                                subInputs.forEach(subInput => {
                                    if ((subInput.type === 'text' || subInput.tagName === 'TEXTAREA') && subInput.value.trim() !== '') {
                                        isSubAnswered = true;
                                    } else if ((subInput.type === 'radio' || subInput.type === 'checkbox') && subInput.checked) {
                                        isSubAnswered = true;
                                    }
                                });

                                if (!isSubAnswered) {
                                    unansweredQuestions.push(`ï¼ˆ${question.title}ï¼‰ä¸‹çš„ã€Œ${subQ.querySelector('h3 .title-text').textContent}ã€`);
                                    subQ.classList.add('unanswered');
                                }
                            });

                            // æª¢æŸ¥ç…§é¡§è€…æ¨¡æ¿
                            const caregiverTemplate = subContentContainer.querySelector('.caregiver-template');
                            if (caregiverTemplate) {
                                const inputs = caregiverTemplate.querySelectorAll('input');
                                const hasCaregiverData = Array.from(inputs).some(input => input.value.trim() !== '');
                                if (!hasCaregiverData) {
                                    unansweredQuestions.push(`ï¼ˆ${question.title}ï¼‰ä¸‹çš„ã€Œç…§é¡§è€…è³‡æ–™ã€`);
                                    caregiverTemplate.classList.add('unanswered');
                                }
                            }
                        }
                    }
                    
                    if (!isAnswered) {
                        unansweredQuestions.push(`ï¼ˆ${category.title}ï¼‰${question.title}`);
                        qElement.classList.add('unanswered');
                    }
                });
            });

            if (unansweredQuestions.length > 0) {
                const message = `å°šæœ‰ä»¥ä¸‹é …ç›®æœªå¡«å¯«ï¼š\n\n- ${unansweredQuestions.join('\n- ')}\n\nè«‹å¡«å¯«å®Œæˆå¾Œå†å˜—è©¦ã€‚`;
                alert(message);
                const firstUnanswered = document.querySelector('.unanswered');
                if (firstUnanswered) {
                    firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            } else {
                alert("æ‰€æœ‰é …ç›®éƒ½å·²å¡«å¯«å®Œæˆï¼");
                return true;
            }
        }

        //åˆ‡æ›ä¸»é¡ŒåŠŸèƒ½
        function switchTheme(themeName) {
            const root = document.documentElement;
            const selectedTheme = themes[themeName];
            for (const property in selectedTheme) {
                root.style.setProperty(property, selectedTheme[property]);
            }
        }

        // ===================================

        // å»ºç«‹æ•´å€‹ ICF é›»è¨ªå•å·çš„ HTML çµæ§‹
        function generateForm() {
            categories.forEach((category, catIndex) => {
                const categoryDiv = document.createElement("div");
                categoryDiv.className = "category-group";
                categoryDiv.id = `cat-${catIndex}`;
                categoryDiv.innerHTML = `<h2>${category.title}</h2>`;

                category.questions.forEach((question, qIndex) => {
                    createQuestionElement(question, qIndex, categoryDiv);
                });

                formContainer.appendChild(categoryDiv);
            });
        }

        // ===================================
        // å…ƒä»¶å»ºç«‹èˆ‡æ¸²æŸ“è¼”åŠ© (Component Creation & Rendering)
        // ===================================

        // å»ºç«‹ä¸¦æ¸²æŸ“å–®å€‹å•é¡Œçš„ HTML å…ƒç´ 
        function createQuestionElement(question, questionIndex, container) {
            const questionCard = document.createElement("div");
            questionCard.className = "question-card";
            const qIdBase = `${question.title.replace(/[\s\/\(\)]/g, "")}`;
            questionCard.id = `q-${qIdBase}-${questionIndex}`;

            const isSubQuestion = typeof questionIndex === 'string';
            const titlePrefix = isSubQuestion ? '' : `ï¼ˆ${chineseNumbers[questionIndex]}ï¼‰`;

            const h3 = document.createElement("h3");
            h3.innerHTML = `<span class="title-prefix">${titlePrefix}</span><span class="title-text">${question.title}</span>`;
            questionCard.appendChild(h3);

            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options-container";
            questionCard.appendChild(optionsContainer);

            if (question.type === "input-only" || question.type === "textarea-only") {
                const input = document.createElement(question.type === "textarea-only" ? "textarea" : "input");
                input.className = question.type === "textarea-only" ? "full-width-textarea" : "full-width-input";
                optionsContainer.appendChild(input);
            } else {
                const inputType = question.type === "single-choice" ? "radio" : "checkbox";
                let subContentContainer;

                const hasPotentialSubContent = question.options.some(opt => typeof opt === 'object' && (opt.subQuestions || opt.hasConditionalTemplate));
                if (hasPotentialSubContent) {
                    subContentContainer = document.createElement("div");
                    subContentContainer.className = "sub-content-container hidden";
                    questionCard.appendChild(subContentContainer);
                }

                question.options.forEach((option, optionIndex) => {
                    const isObject = typeof option === 'object' && option !== null;
                    const optionText = isObject ? option.text : option;
                    const label = document.createElement("label");
                    label.className = "option";
                    const inputId = `${qIdBase}-${questionIndex}-${optionIndex}`;
                    const inputName = question.name || `${qIdBase}-${questionIndex}`;
                    label.innerHTML = `<input type="${inputType}" name="${inputName}" value="${optionText}" id="${inputId}">${optionText}`;
                    optionsContainer.appendChild(label);
                    const inputElement = label.querySelector("input");
                    if (isObject && option.hasInputField) {
                        const inputField = document.createElement("input");
                        inputField.type = "text";
                        inputField.placeholder = "è«‹å¡«å¯«";
                        inputField.className = "conditional-input";
                        inputField.style.display = "none";
                        label.appendChild(inputField);
                        inputElement.addEventListener("change", () => {
                            inputField.style.display = inputElement.checked ? "inline-block" : "none";
                            if (!inputElement.checked) inputField.value = "";
                        });
                    }
                });

                if (subContentContainer) {
                    const inputName = question.name || `${qIdBase}-${questionIndex}`;
                    const allInputsInGroup = optionsContainer.querySelectorAll(`input[name="${inputName}"]`);
                    const handleSubContentDisplay = () => {
                        const checkedInput = optionsContainer.querySelector(`input[name="${inputName}"]:checked`);
                        subContentContainer.innerHTML = '';
                        subContentContainer.classList.add("hidden");
                        if (!checkedInput) return;
                        const selectedOptionData = question.options.find(opt => (typeof opt === 'object' ? opt.text : opt) === checkedInput.value);

                        let subQuestionsToShow = [];
                        if (selectedOptionData && typeof selectedOptionData === 'object') {
                            if (selectedOptionData.subQuestions) {
                                subQuestionsToShow = selectedOptionData.subQuestions;
                            }
                        }
                        
                        if (subQuestionsToShow.length > 0) {
                            subQuestionsToShow.forEach((subQ, subQIndex) => {
                                createQuestionElement(subQ, `${questionIndex}-${subQIndex}`, subContentContainer);
                            });
                            subContentContainer.classList.remove("hidden");

                            if (question.title === 'è¼”å…·ä½¿ç”¨') {
                                const assistiveDevicesCheckboxes = subContentContainer.querySelectorAll('input[name^="assistive-devices-list"]');
                                assistiveDevicesCheckboxes.forEach(checkbox => {
                                    checkbox.addEventListener('change', () => updateMobilityOptions(subContentContainer));
                                });
                                updateMobilityOptions(subContentContainer);
                            }
                        }
                    };
                    allInputsInGroup.forEach(input => {
                        input.addEventListener('change', handleSubContentDisplay);
                    });
                }
            }
            container.appendChild(questionCard);
        }

        // éè¿´åœ°è§£æå’Œè™•ç†å®¹å™¨å…§çš„å­å•é¡Œï¼ˆSub-Questionsï¼‰
        function parseSubQuestionsRecursively(container, indent = ' Â ') {
            if (!container) return "";

            const directChildQuestionCards = Array.from(container.querySelectorAll(':scope > .question-card'));
            let outputString = "";
            
            const answeredCardsInfo = directChildQuestionCards.map(card => {
                const title = card.querySelector('h3').textContent.trim();
                const optionsDiv = card.querySelector(':scope > .options-container');
                const answer = parseAnswersFromContainer(optionsDiv);
                const subContainer = card.querySelector('.sub-content-container:not(.hidden)');
                return { card, title, answer, subContainer };
            }).filter(info => info.answer);

            answeredCardsInfo.forEach((info, index) => {
                const isLast = index === answeredCardsInfo.length - 1;
                const prefix = isLast ? 'â””' : 'â”œ';

                outputString += `\n${indent}${prefix} ${info.title}ï¼š${info.answer}`;
                
                if (info.subContainer) {
                    // å‚³å…¥å­å®¹å™¨ï¼Œä¸¦å¢åŠ ä¸‹ä¸€å±¤çš„ç¸®æ’
                    outputString += parseSubQuestionsRecursively(info.subContainer, indent + ' Â ');
                }
            });

            return outputString;
        }

        // å»ºç«‹ç”¨æ–¼é¸æ“‡ã€Œç§»å‹•/æ´»å‹•èƒ½åŠ› (Mobility)ã€ç›¸é—œé¸é …çš„ Select (ä¸‹æ‹‰å¼é¸å–®) å…ƒç´ 
        function createMobilitySelect() {
            const select = document.createElement('select');
            select.name = 'mobility-select';
            select.style.marginLeft = '10px';
            select.disabled = true;

            const defaultOption = document.createElement('option');
            defaultOption.value = "è«‹é¸æ“‡";
            defaultOption.textContent = "è«‹é¸æ“‡";
            select.appendChild(defaultOption);

            mobilityOptions.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                select.appendChild(option);
            });
            return select;
        }

        // å»ºç«‹ç”¨æ–¼ã€Œç§»å‹•/æ´»å‹•èƒ½åŠ›ã€å€å¡Šçš„å–®å€‹é¸é …å…ƒç´ ï¼ˆå¦‚ Radio æˆ– Checkboxï¼‰
        function createMobilityOptionElement(questionCardId, value, isChecked = false) {
            const label = document.createElement("label");
            label.className = "option";

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = `${questionCardId}-devices`; 
            checkbox.value = value;
            checkbox.checked = isChecked;

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(value));

            const select = createMobilitySelect();
            select.disabled = !isChecked; // åˆå§‹åŒ–æ™‚æ ¹æ“šæ˜¯å¦å‹¾é¸ä¾†ç¦ç”¨
            label.appendChild(select);

            return label;
        }

        // --- èº«å¿ƒéšœç¤™ç¦åˆ©è³‡æ–™åº«æ¨¡çµ„---
        // 1. è¨­å®šè³‡æ–™ä¾†æº
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT01_KXlCmpnlBwu0mqiix2GIi08QyF7ds5aN_UPiYM9RwANk2GThj_g8gnGA5edsF0YZuY2OTtWnX2/pub?gid=0&single=true&output=csv';

        // â­ åŠ ä¸Šä»£ç†ä¼ºæœå™¨ (é€™æ˜¯è§£æ±ºç„¡æ³•è¼‰å…¥çš„é—œéµ)
        const CSV_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(GOOGLE_SHEET_URL);

        let welfareData = []; 

        // 2. UI å…ƒç´ æ§åˆ¶
        const sidebar = document.getElementById('welfare-sidebar');
        const toggleBtn = document.getElementById('welfare-toggle-btn');
        const closeBtn = document.getElementById('welfare-close-btn');
        const searchInput = document.getElementById('welfare-search-input');
        const resultsContainer = document.getElementById('welfare-results-container');

        // 3. äº‹ä»¶ç›£è½
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            if (welfareData.length === 0) {
                fetchWelfareData();
            }
        });

        closeBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            filterAndRender(keyword);
        });

        // 4. æŠ“å–ä¸¦è§£æ CSV è³‡æ–™
        function fetchWelfareData() {
            resultsContainer.innerHTML = '<div class="loading-text">è³‡æ–™ä¸‹è¼‰ä¸­...è«‹ç¨å€™</div>';
            
            fetch(CSV_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // æª¢æŸ¥æ˜¯å¦æŠ“åˆ°äº†éŒ¯èª¤çš„å…§å®¹ (æœ‰æ™‚å€™ä»£ç†ä¼ºæœå™¨æœƒå›å‚³ç©ºçš„)
                    if (!csvText || csvText.length < 10) {
                        throw new Error('Empty response');
                    }
                    welfareData = parseCSV(csvText);
                    renderResults(welfareData);
                })
                .catch(error => {
                    console.error('è©³ç´°éŒ¯èª¤è³‡è¨Š:', error); // é€™è¡Œæœƒè®“æ‚¨åœ¨ F12 çœ‹åˆ°çœŸæ­£åŸå› 
                    resultsContainer.innerHTML = `
                        <div class="loading-text" style="color:red;">
                            ç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚<br>
                            <small>éŒ¯èª¤ä»£ç¢¼: ${error.message}</small>
                        </div>`;
                });
        }

        // â­ å°ˆæ¥­ç´š CSV è§£æå™¨ (å¯å®Œç¾è™•ç†å„²å­˜æ ¼å…§çš„æ›è¡Œèˆ‡é€—è™Ÿ)
        function parseCSV(text) {
            // 1. ç§»é™¤ BOM é˜²æ­¢äº‚ç¢¼
            let source = text.replace(/^\uFEFF/, ''); 
            
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;

            // 2. é€å­—è§£æ (Character-by-character parsing)
            for (let i = 0; i < source.length; i++) {
                const char = source[i];
                const nextChar = source[i + 1];

                if (char === '"') {
                    // è™•ç†é›™å¼•è™Ÿ
                    if (inQuotes && nextChar === '"') {
                        // å¦‚æœæ˜¯é€£çºŒå…©å€‹é›™å¼•è™Ÿï¼Œè¡¨ç¤ºå…§å®¹ä¸­çš„ä¸€å€‹å¼•è™Ÿ (è½‰ç¾©)
                        currentField += '"';
                        i++; // è·³éä¸‹ä¸€å€‹å¼•è™Ÿ
                    } else {
                        // åˆ‡æ›å¼•è™Ÿç‹€æ…‹ (é–‹å§‹æˆ–çµæŸä¸€å€‹å¼•è™Ÿå€å¡Š)
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // é‡åˆ°é€—è™Ÿï¼Œä¸”ä¸åœ¨å¼•è™Ÿå…§ -> æ¬„ä½çµæŸ
                    currentRow.push(currentField);
                    currentField = '';
                } else if ((char === '\r' || char === '\n') && !inQuotes) {
                    // é‡åˆ°æ›è¡Œï¼Œä¸”ä¸åœ¨å¼•è™Ÿå…§ -> æ•´åˆ—çµæŸ
                    // è™•ç† \r\n çš„æƒ…æ³ï¼Œå¦‚æœç¾åœ¨æ˜¯ \r ä¸”ä¸‹ä¸€å€‹æ˜¯ \nï¼Œå‰‡è·³é \n
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                    
                    // åªæœ‰ç•¶é€™ä¸€è¡Œä¸æ˜¯ç©ºçš„ï¼Œæ‰å­˜å…¥
                    // (é¿å…æª”æ¡ˆæœ€å¾Œå¤šä¸€å€‹ç©ºè¡Œå°è‡´ç”¢ç”Ÿç©ºç‰©ä»¶)
                    if (currentRow.length > 0 || currentField.trim() !== '') {
                        currentRow.push(currentField);
                        rows.push(currentRow);
                    }
                    
                    currentRow = [];
                    currentField = '';
                } else {
                    // ä¸€èˆ¬å­—å…ƒï¼Œç›´æ¥åŠ å…¥ç›®å‰æ¬„ä½
                    currentField += char;
                }
            }

            // è£œä¸Šæœ€å¾Œä¸€åˆ— (å¦‚æœæª”æ¡ˆä¸æ˜¯ä»¥æ›è¡ŒçµæŸ)
            if (currentRow.length > 0 || currentField.trim() !== '') {
                currentRow.push(currentField);
                rows.push(currentRow);
            }

            // 3. å°‡é™£åˆ—è½‰æ›ç‚ºç‰©ä»¶ (Mapping)
            if (rows.length < 2) return []; // æ²’æœ‰è³‡æ–™

            // æ¨™é¡Œåˆ—é€šå¸¸æ˜¯ç¬¬ä¸€åˆ—ï¼Œä½†ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘æŠŠå‰å¾Œç©ºç™½å»æ‰
            const headers = rows[0].map(h => h.trim());
            
            const result = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                // åªæœ‰ç•¶æ¬„ä½æ•¸é‡è·Ÿæ¨™é¡Œæ•¸é‡å¤§è‡´ç›¸ç¬¦æ‰è™•ç†
                // (æ”¾å¯¬æ¨™æº–ï¼šåªè¦æœ‰è³‡æ–™å°±ç®—)
                if (row.length > 0) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        // å°æ‡‰æ¨™é¡Œèˆ‡å…§å®¹
                        obj[header] = row[index] ? row[index].trim() : '';
                    });
                    result.push(obj);
                }
            }
            return result;
        }

        // 5. æœå°‹èˆ‡æ¸²æŸ“é‚è¼¯
        function filterAndRender(keyword) {
            if (!keyword) {
                renderResults(welfareData);
                return;
            }
            
            const filtered = welfareData.filter(item => {
                return Object.values(item).some(val => 
                    val.toLowerCase().includes(keyword)
                );
            });
            
            renderResults(filtered);
        }

        // â­ é‡å°æ‚¨çš„è³‡æ–™çµæ§‹å®¢è£½åŒ–çš„æ¸²æŸ“å‡½å¼
        function renderResults(data) {
            resultsContainer.innerHTML = '';

            // è¼”åŠ©å‡½å¼ï¼šå°‡è³‡æ–™ä¸­çš„æ›è¡Œç¬¦è™Ÿ (\n) è½‰æ›ç‚º HTML çš„ <br> æ¨™ç±¤
            const formatText = (text) => {
                if (!text) return '';
                return text.replace(/\n/g, '<br>');
            };
            
            if (data.length === 0) {
                resultsContainer.innerHTML = '<div class="loading-text">æ‰¾ä¸åˆ°ç¬¦åˆçš„ç¦åˆ©é …ç›®</div>';
                return;
            }
            
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'welfare-card';
                
                // å–å¾—ä¸¦æ ¼å¼åŒ–è³‡æ–™
                const title = item['è³‡æºåç¨±'] || 'æœªå‘½åé …ç›®';
                const category = item['ç¶“æ¿Ÿï¼æ”¯æŒ'] || 'ä¸€èˆ¬';
                
                // ç¢ºä¿å…§å®¹è®Šæ•¸ä¹Ÿç¶“é formatText è™•ç†
                const content = formatText(item['ç¦åˆ©å…§å®¹'] || 'ç„¡è©³ç´°èªªæ˜');
                const requirementText = item['ç”³è«‹è³‡æ ¼'] || '';
                const contactText = item['çª—å£'] || '';

                // ç¢ºä¿å…§å®¹é¡¯ç¤ºæ›è¡Œ
                const requirement = requirementText 
                    ? `<p><strong>é ˆç¬¦åˆä»¥ä¸‹æ¢ä»¶æ–¹å¯ç”³è«‹ï¼š</strong><br>${formatText(requirementText)}</p>` 
                    : '';
                // ç¢ºä¿çª—å£é¡¯ç¤ºæ›è¡Œ
                const contact = contactText 
                    ? `<p><strong>çª—å£ï¼š</strong><br>${formatText(contactText)}</p>` 
                    : '';

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h4 style="margin:0; color:#2c3e50;">${title}</h4>
                        <span class="welfare-tag">${category}</span>
                    </div>
                    <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
                    
                    <p><strong>å…§å®¹ï¼š</strong><br>${content}</p>  ${requirement}
                    ${contact}
                `;
                
                resultsContainer.appendChild(card);
            });
        }

        // ===================================
        // è¡¨å–®åŠŸèƒ½èˆ‡ç‹€æ…‹ç®¡ç† (Form Utility & Management)
        // ===================================

        // æ ¹æ“šç•¶å‰è¡¨å–®ç‹€æ…‹æˆ–å…¶ä»–æ¢ä»¶ï¼Œå‹•æ…‹æ›´æ–°ã€Œç§»å‹•/æ´»å‹•èƒ½åŠ›ã€é¸é …å€å¡Šçš„å…§å®¹
        function updateMobilityOptions(container) {
            if (!container) return;

            const sourceCheckboxes = Array.from(container.querySelectorAll('input[name^="assistive-devices-list"]:checked'));
            const indoorMobilityCard = Array.from(container.querySelectorAll('.question-card h3')).find(h3 => h3.textContent.includes('å±…å®¶ï¼ç†Ÿæ‚‰ç’°å¢ƒ'));
            const outdoorMobilityCard = Array.from(container.querySelectorAll('.question-card h3')).find(h3 => h3.textContent.includes('æˆ¶å¤–ç§»å‹•æ–¹å¼'));

            if (!indoorMobilityCard || !outdoorMobilityCard) return;

            const indoorOptionsContainer = indoorMobilityCard.nextElementSibling;
            const outdoorOptionsContainer = outdoorMobilityCard.nextElementSibling;

            // æ¸…ç©ºèˆŠçš„æ‰€æœ‰é¸é …
            indoorOptionsContainer.innerHTML = '';
            outdoorOptionsContainer.innerHTML = '';
            
            const createMobilityOption = (deviceName, namePrefix) => {
                const label = document.createElement('label');
                label.className = 'option';
                
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.name = `${namePrefix}-${deviceName.replace(/\s/g, '')}`; // ç§»é™¤deviceNameä¸­çš„ç©ºæ ¼ä»¥ç¢ºä¿nameæœ‰æ•ˆ
                checkboxInput.value = deviceName;
                
                const select = document.createElement('select');
                
                // â­ã€éœ€æ±‚ 2ã€‘: é è¨­ç‚ºåœç”¨ç‹€æ…‹ (ç°è‰²ã€ç„¡æ³•é»æ“Š)
                select.disabled = true;
                
                const defaultSelectOption = document.createElement('option');
                defaultSelectOption.textContent = 'è«‹é¸æ“‡';
                select.appendChild(defaultSelectOption);
                
                mobilityOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
                
                // â­ã€éœ€æ±‚ 3ã€‘: ç¶å®šäº‹ä»¶ï¼Œé»æ“Š checkbox ä¾†å•Ÿç”¨/åœç”¨ select
                checkboxInput.addEventListener('change', () => {
                    if (checkboxInput.checked) {
                        select.disabled = false; // å•Ÿç”¨ select
                    } else {
                        select.disabled = true;  // åœç”¨ select
                        select.selectedIndex = 0; // å¦‚æœå–æ¶ˆå‹¾é¸ï¼Œé‡ç½® select çš„é¸é …
                    }
                });
                
                label.appendChild(checkboxInput);
                label.append(` ${deviceName} `);
                label.appendChild(select);
                
                return label;
            };
            
            // â­ã€éœ€æ±‚ 1ã€‘: ç‚º "ä¸ä½¿ç”¨è¼”å…·" ä¹Ÿä½¿ç”¨æ–°çš„ç”Ÿæˆå™¨ï¼Œè®“å®ƒä¹Ÿæ“æœ‰ select
            indoorOptionsContainer.appendChild(createMobilityOption('ä¸ä½¿ç”¨è¼”å…·', 'indoor-mobility'));
            outdoorOptionsContainer.appendChild(createMobilityOption('ä¸ä½¿ç”¨è¼”å…·', 'outdoor-mobility'));

            // æ ¹æ“šä¾†æº checkboxï¼Œå‹•æ…‹ç”Ÿæˆå…¶ä»–çš„è¼”å…·é¸é …
            sourceCheckboxes.forEach(checkbox => {
                const deviceName = checkbox.value;
                indoorOptionsContainer.appendChild(createMobilityOption(deviceName, 'indoor-mobility'));
                outdoorOptionsContainer.appendChild(createMobilityOption(deviceName, 'outdoor-mobility'));
            });
        }

        // æ¸…ç©ºæˆ–é‡è¨­æ•´å€‹è¡¨å–®çš„æ‰€æœ‰è¼¸å…¥æ¬„ä½å’Œé¸æ“‡ç‹€æ…‹
        function clearForm() {
            const formInputs = formContainer.querySelectorAll('input, textarea, select');
            
            formInputs.forEach(input => {
                const type = input.type;
                
                if (type === 'radio' || type === 'checkbox') {
                    if (input.checked) { // åªå°å·²å‹¾é¸çš„é€²è¡Œæ“ä½œï¼Œæ•ˆç‡æ›´é«˜
                        input.checked = false;
                        
                        // â­ é­”æ³•å°±åœ¨é€™è£¡ â­
                        // æ‰‹å‹•è§¸ç™¼ change äº‹ä»¶ï¼Œé€šçŸ¥æˆ‘å€‘çš„å‹•æ…‹ç³»çµ±é€²è¡Œæ›´æ–°ï¼
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    if (input.value !== '') { // åªå°æœ‰å…§å®¹çš„é€²è¡Œæ“ä½œ
                        input.value = '';
                        // æ–‡å­—è¼¸å…¥æ¡†çš„é‡ç½®ä¹Ÿæœ€å¥½é€šçŸ¥ä¸€ä¸‹ï¼Œä»¥é˜²è¬ä¸€
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });

    // æ¸…é™¤é ‚éƒ¨çš„ header æ¬„ä½
    document.getElementById("survey-number").value = '';
    document.getElementById("machine-number").selectedIndex = 0;
    document.getElementById("respondent-type").selectedIndex = 0;
    document.getElementById("flow-three").selectedIndex = 0;
    
    // æ¸…é™¤æ‰€æœ‰æœªå¡«å¯«çš„ç´…è‰²æé†’æ¡†
    const unansweredElements = document.querySelectorAll('.unanswered');
    unansweredElements.forEach(el => el.classList.remove('unanswered'));
}

        // ============================================
        // è³‡æ–™æ“·å–èˆ‡è§£æ (Data Collection & Parsing)
        // ============================================

        // æ”¶é›†ä¸¦å›å‚³æ•´å€‹ ICF é›»è¨ªå•å·è¡¨å–®çš„ä½¿ç”¨è€…å¡«å¯«è³‡æ–™
        function getFormData() {
            let result = "";
            const headerFields = {
                "å•å·ç·¨è™Ÿ": document.getElementById("survey-number").value.trim(),
                "ä¸»æ©Ÿ": document.getElementById("machine-number").value.trim(),
                "å—è¨ªè€…": document.getElementById("respondent-type").value.trim(),
                "åˆ†æµä¸‰": document.getElementById("flow-three").value.trim()
            };

            categories.forEach((category, catIndex) => {
                let categoryContent = "";
                const categoryElement = document.querySelector(`#cat-${catIndex}`);
                if (!categoryElement) return;

                category.questions.forEach((question, qIndex) => {
                    const qElement = categoryElement.querySelector(`#q-${question.title.replace(/[\s\/\(\)]/g, "")}-${qIndex}`);
                    if (!qElement) return;

                    const titlePrefix = `ï¼ˆ${chineseNumbers[qIndex]}ï¼‰${question.title}`;
                    let mainAnswerText = "";
                    let finalOutput = "";

                    if (question.type === "input-only" || question.type === "textarea-only") {
                        const inputElement = qElement.querySelector("input, textarea");
                        if (inputElement && inputElement.value.trim()) {
                            mainAnswerText = inputElement.value.trim();
                        }
                    } else {
                        mainAnswerText = parseAnswersFromContainer(qElement.querySelector('.options-container'));
                    }

                    if (mainAnswerText) {
                        // æ­¥é©Ÿ 2: å»ºç«‹åŒ…å«ä¸»ç­”æ¡ˆçš„ç¬¬ä¸€è¡Œ
                        finalOutput = `${titlePrefix}ï¼š${mainAnswerText}`;

                        const subContentContainer = qElement.querySelector(".sub-content-container:not(.hidden)");
                        if (subContentContainer) {
                            const subAnswersString = parseSubQuestionsRecursively(subContentContainer);
                            
                            if (subAnswersString) {
                                finalOutput += subAnswersString;
                            }
                        }
                    }

                    if (finalOutput) {
                        categoryContent += `${finalOutput}\n\n`;
                    }
                });

                if (categoryContent) {
                    result += `${category.title}\n${categoryContent}`;
                }
            });

            return result;
        }

        // å¾ç‰¹å®šå•é¡Œå¡ç‰‡çš„ HTML å…ƒç´ ä¸­ï¼Œæ“·å–å‡ºä½¿ç”¨è€…çš„å›ç­”è³‡æ–™
        function getQuestionData(questionCard, question) {
            if (!questionCard || !question) return "";

            if (question.type === 'multiple-choice' || question.type === 'single-choice') {
                const checkedInputs = Array.from(questionCard.querySelectorAll(':scope > .options-container > .option > input:checked'));
                if (checkedInputs.length > 0) {
                    return checkedInputs.map(getOptionText).join("ã€");
                }
                return "";
            }
            return "";
        }

        // å¾ç‰¹å®šå•é¡Œå¡ç‰‡ä¸­ï¼Œæ“·å–èˆ‡ã€Œç§»å‹•/æ´»å‹•èƒ½åŠ› (Mobility)ã€ç›¸é—œçš„è³‡æ–™
        function getMobilityData(questionCard) {
            const selectedOptions = [];
            const optionsContainer = questionCard.querySelector(".options-container");
            const labels = optionsContainer.querySelectorAll("label");

            labels.forEach(label => {
                const checkbox = label.querySelector('input[type="checkbox"]');
                const select = label.querySelector('select');

                if (checkbox && checkbox.checked) {
                    let optionText = checkbox.value;
                    if (select && select.value !== "è«‹é¸æ“‡") {
                        optionText += `ï¼ˆ${select.value}ï¼‰`;
                    }
                    selectedOptions.push(optionText);
                }
            });

            return selectedOptions;
        }

        // è§£æé¸é …å®¹å™¨ï¼ˆOptions Containerï¼‰ä¸­çš„ä½¿ç”¨è€…é¸æ“‡ï¼Œä¸¦æ•´ç†æˆå›ç­”é™£åˆ—æˆ–ç‰©ä»¶
        function parseAnswersFromContainer(optionsContainer) {
            if (!optionsContainer) return "";

            // å„ªå…ˆ 1: å°‹æ‰¾ã€Œå‹¾é¸é¡Œã€ï¼ˆradio/checkboxï¼‰çš„ç­”æ¡ˆ
            const checkedInputs = Array.from(optionsContainer.querySelectorAll('.option > input:checked'));
            if (checkedInputs.length > 0) {
                // å¦‚æœæ‰¾åˆ°äº†ï¼Œé€™å°±æ˜¯ä¸€å€‹ single-choice æˆ– multiple-choice é¡Œ
                // ä½¿ç”¨ getOptionText ä¾†ç¢ºä¿èƒ½æŠ“åˆ° select çš„å€¼
                return checkedInputs.map(getOptionText).join("ã€");
            }

            // å„ªå…ˆ 2: å¦‚æœæ‰¾ä¸åˆ°å‹¾é¸é¡Œï¼Œå°±å°‹æ‰¾ã€Œè¼¸å…¥æ¡†ã€ï¼ˆinput-only / textarea-onlyï¼‰
            // é€™äº›é¡Œç›®çš„è¼¸å…¥æ¡†æœƒè¢«ç›´æ¥æ”¾åœ¨ optionsContainer è£¡
            const simpleInput = optionsContainer.querySelector('input.full-width-input, textarea.full-width-textarea');
            if (simpleInput && simpleInput.value.trim()) {
                // å¦‚æœæ‰¾åˆ°äº†ï¼Œé€™å°±æ˜¯ä¸€å€‹ input-only æˆ– textarea-only é¡Œ
                return simpleInput.value.trim();
            }

            // å¦‚æœä»¥ä¸Šçš†éï¼ˆä¾‹å¦‚ä¸€å€‹ç©ºçš„å‹¾é¸é¡Œï¼‰ï¼Œå‰‡å›å‚³ç©ºå­—ä¸²
            return "";
        }

        // å–å¾—è¼¸å…¥å…ƒç´ ï¼ˆå¦‚ Radio æˆ– Checkboxï¼‰æ‰€å°æ‡‰çš„é¸é …æ–‡å­—æè¿°
        function getOptionText(inputElement) {
        Â  Â const label = inputElement.closest('label');
        Â  Â if (!label) return inputElement.value; 

        Â  Â let text = inputElement.value;

        Â  Â const conditionalInput = label.querySelector('.conditional-input');
        Â  Â if (conditionalInput && conditionalInput.style.display !== 'none' && conditionalInput.value.trim()) {
        Â  Â  Â  Â text += `ï¼ˆ${conditionalInput.value.trim()}ï¼‰`;
        Â  Â }

        Â  Â const selectElement = label.querySelector('select');
        Â  Â if (selectElement && selectElement.value && selectElement.value !== "è«‹é¸æ“‡") {
        Â  Â  Â  Â text += `ï¼ˆ${selectElement.value}ï¼‰`;
        Â  Â }

        Â  Â return text;
        }

        document.addEventListener("DOMContentLoaded", () => {
            generateForm();

            // å°å·¥å…·å’Œä¸»é¡Œçš„ä¸‹æ‹‰å¼é¸å–®åŠŸèƒ½
            const toolsToggleBtn = document.getElementById("tools-toggle");
            const toolsDropdown = document.getElementById("tools-dropdown");
            const themeToggleBtn = document.querySelector("#theme-tools button");
            const themeDropdown = document.getElementById("theme-dropdown");
            const validateBtn = document.getElementById("validate-btn");

            toolsToggleBtn.addEventListener("click", (event) => {
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° document
                toolsDropdown.classList.toggle("active");
                themeDropdown.classList.remove("active"); // ç¢ºä¿å­é¸å–®åœ¨çˆ¶é¸å–®é—œé–‰æ™‚ä¸€ä½µé—œé–‰
            });

            themeToggleBtn.addEventListener("click", (event) => {
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° toolsToggleBtn
                themeDropdown.classList.toggle("active");
            });

            // é»æ“Šå·¥å…·å€å¡Šä»¥å¤–çš„åœ°æ–¹ï¼Œéš±è—æ‰€æœ‰ä¸‹æ‹‰å¼é¸å–®
            document.addEventListener("click", (event) => {
                const isClickInsideTools = toolsDropdown.contains(event.target) || toolsToggleBtn.contains(event.target);
                if (!isClickInsideTools && toolsDropdown.classList.contains("active")) {
                    toolsDropdown.classList.remove("active");
                }
            });

            // æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            document.getElementById("theme-beige").addEventListener("click", () => {
                switchTheme('beige');
                toolsDropdown.classList.remove("active"); // åˆ‡æ›å¾Œè‡ªå‹•é—œé–‰é¸å–®
            });

            document.getElementById("theme-green").addEventListener("click", () => {
                switchTheme('green');
                toolsDropdown.classList.remove("active");
            });

            document.getElementById("theme-gray").addEventListener("click", () => {
                switchTheme('gray');
                toolsDropdown.classList.remove("active");
            });

            // æª¢æŸ¥æœªå¡«å¯«é …ç›®æŒ‰éˆ•çš„äº‹ä»¶
            validateBtn.addEventListener("click", () => {
                validateForm();
                toolsDropdown.classList.remove("active");
            });

            document.getElementById("copy-btn").addEventListener("click", () => {
                const content = getFormData();
                if (content) {
                    navigator.clipboard.writeText(content).then(() => {
                        alert("å…§å®¹å·²è¤‡è£½ï¼");
                    }).catch(err => {
                        alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼éŒ¯èª¤ï¼š" + err);
                    });
                } else {
                    alert("æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹ã€‚");
                }
            });

            document.getElementById("download-btn").addEventListener("click", () => {
                const surveyNumber = document.getElementById("survey-number").value || "æœªå¡«å¯«";
                const machineNumber = document.getElementById("machine-number").value || "æœªå¡«å¯«";
                const respondentType = document.getElementById("respondent-type").value || "æœªå¡«å¯«";
                const flowThree = document.getElementById("flow-three").value || "æœªå¡«å¯«";

                const filename = `${surveyNumber}-ä¸»æ©Ÿ${machineNumber}-${respondentType}-åˆ†æµä¸‰(${flowThree}).txt`;
                const content = getFormData();
                if (content) {
                    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                } else {
                    alert("æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹ã€‚");
                }
            });

            document.getElementById("clear-btn").addEventListener("click", clearForm);
        });

		// --- è‡ªå‹•æš«å­˜åŠŸèƒ½æ¨¡çµ„ ---

// 1. è¨­å®šå„²å­˜çš„ Key åç¨± (å¯ä»¥è‡ªè¨‚)
const STORAGE_KEY = 'disability_form_draft';

// 2. ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚ï¼Œæ¢å¾©ä¹‹å‰çš„æš«å­˜è³‡æ–™
document.addEventListener('DOMContentLoaded', () => {
    restoreFormData();
    
    // 3. ç›£è½é é¢ä¸Šæ‰€æœ‰çš„è¼¸å…¥è®Šå‹•
    // åªè¦æœ‰ä»»ä½• input, textarea, select æ”¹è®Šï¼Œå°±è§¸ç™¼å­˜æª”
    document.addEventListener('input', (event) => {
        if (event.target.matches('input, textarea, select')) {
            saveFormData();
        }
    });
});

// å‡½å¼ï¼šå°‡ç›®å‰çš„è¡¨å–®å…§å®¹å­˜å…¥ localStorage
function saveFormData() {
    const formData = {};
    
    // æŠ“å–é é¢ä¸Šæ‰€æœ‰å…·æœ‰ id çš„è¼¸å…¥æ¬„ä½
    const inputs = document.querySelectorAll('input, textarea, select');
    
    inputs.forEach(input => {
        if (input.id) { // å¿…é ˆæœ‰ id æ‰èƒ½å°æ‡‰å­˜æª”
            if (input.type === 'checkbox' || input.type === 'radio') {
                formData[input.id] = input.checked;
            } else {
                formData[input.id] = input.value;
            }
        }
    });

    // è½‰æˆ JSON å­—ä¸²å„²å­˜
    localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
    console.log('è‰ç¨¿å·²è‡ªå‹•å„²å­˜...'); // æ¸¬è©¦ç”¨ï¼Œç©©å®šå¾Œå¯åˆªé™¤
}

// å‡½å¼ï¼šå¾ localStorage è®€å–ä¸¦æ¢å¾©è³‡æ–™
function restoreFormData() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    
    if (savedData) {
        const formData = JSON.parse(savedData);
        
        Object.keys(formData).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = formData[id];
                } else {
                    element.value = formData[id];
                }
            }
        });
        console.log('å·²å¾æš«å­˜æ¢å¾©è³‡æ–™ï¼');
    }
}

// ğŸ’¡ é¡å¤–å»ºè­°ï¼šç•¶ä½¿ç”¨è€…ã€Œæ­£å¼æäº¤ã€å•å·æˆåŠŸå¾Œï¼Œè¦è¨˜å¾—æ¸…ç©ºæš«å­˜
function clearDraft() {
    localStorage.removeItem(STORAGE_KEY);
}
    </script>
</body>
</html>




